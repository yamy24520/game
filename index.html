<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Maiko Survival NYC ğŸ—½</title>
<link rel="icon" href="data:,">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  :root{
    --glass: rgba(255,255,255,.15);
    --glass-2: rgba(255,255,255,.22);
    --ink:#fff; --ink-dark:#333;
    --brand1:#667eea; --brand2:#764ba2;
    --warn:#ff6b6b; --ok:#22c55e; --gold:#ffd700;
  }
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,system-ui,sans-serif;background:linear-gradient(135deg,var(--brand1),var(--brand2));min-height:100vh;color:var(--ink);overflow-x:hidden;touch-action:pan-y}
  .game-container{max-width:540px;margin:0 auto;padding:16px 16px 88px}
  .header{text-align:center;padding:16px 10px;animation:fadeIn .5s ease-in}
  .header h1{font-size:1.9em;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
  .sub{opacity:.85}
  .mood-indicator{font-size:2.2em;margin:8px 0}
  .row{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .stats-container{background:var(--glass);backdrop-filter:blur(10px);border-radius:16px;padding:14px;margin:12px 0;border:1px solid rgba(255,255,255,.2)}
  .stat{margin-bottom:10px}
  .stat:last-child{margin-bottom:0}
  .stat-label{display:flex;justify-content:space-between;font-weight:600;font-size:.95em;margin-bottom:6px}
  .stat-label.crit{color:var(--gold);text-shadow:0 0 8px rgba(255,215,0,.6)}
  .stat-bar{width:100%;height:16px;background:rgba(0,0,0,.28);border-radius:10px;overflow:hidden}
  .stat-fill{height:100%;border-radius:10px;transition:width .35s ease}
  .money-fill{background:linear-gradient(90deg,#ffd700,#ffed4e)}
  .energy-fill{background:linear-gradient(90deg,#4ecdc4,#44a8a0)}
  .hunger-fill{background:linear-gradient(90deg,#ff6b6b,#ee5a52)}
  .patience-fill{background:linear-gradient(90deg,#a8e6cf,#7bc9a0)}
  .yamy-fill{background:linear-gradient(90deg,#ff69b4,#ff1493)}
  .topline{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 0}
  .turns{font-size:.9em;opacity:.9}
  .turns b{font-size:1.05em}
  .day-counter{text-align:center;font-size:1.35em;font-weight:700;margin:6px 0}
  .event-card{background:rgba(255,255,255,.2);backdrop-filter:blur(8px);border-radius:16px;padding:16px;border:2px solid rgba(255,255,255,.28);box-shadow:0 8px 28px rgba(0,0,0,.1);margin-top:10px}
  .event-rare{border-color:#ffd700;box-shadow:0 0 0 2px rgba(255,215,0,.3)}
  .event-emoji{font-size:2.2em;text-align:center;margin-bottom:8px}
  .event-title{text-align:center;font-weight:800;margin-bottom:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;font-size:.8em;background:rgba(0,0,0,.25);padding:4px 8px;border-radius:999px;margin:6px auto 10px}
  .event-description{text-align:center;opacity:.95;margin-bottom:12px}
  .choices{display:flex;flex-direction:column;gap:10px}
  .choice-btn{position:relative;background:rgba(255,255,255,.16);border:2px solid rgba(255,255,255,.35);border-radius:14px;padding:12px 14px;text-align:left;color:#fff;font-weight:650;cursor:pointer}
  .choice-btn[disabled]{opacity:.6;cursor:not-allowed}
  .choice-line{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .effects{font-size:.85em;opacity:.9;margin-top:4px;line-height:1.25}
  .mini{font-size:.85em;opacity:.9}
  .start-screen,.game-over{text-align:center}
  .start-box{background:var(--glass);backdrop-filter:blur(10px);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,.2);margin-top:12px}
  .select{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .pill{padding:8px 12px;border-radius:999px;border:2px solid #ffd700;background:rgba(255,215,0,.18);cursor:pointer;font-weight:700}
  .pill.active{background:#ffd700;color:#333}
  .start-btn,.restart-btn{margin-top:14px;background:linear-gradient(135deg,#ffd700,#ff6b6b);border:none;border-radius:22px;padding:12px 28px;font-size:1.05em;color:#fff;font-weight:800;cursor:pointer}
  .bottom-nav{position:fixed;inset:auto 0 0 0;background:rgba(0,0,0,.82);backdrop-filter:blur(10px);padding:10px;display:flex;justify-content:space-around;z-index:1000}
  .nav-btn{background:rgba(255,255,255,.14);border:2px solid rgba(255,255,255,.35);border-radius:12px;padding:10px 14px;font-size:1.05em;color:#fff;cursor:pointer;position:relative}
  .badge-count{position:absolute;top:-7px;right:-7px;background:#ff6b6b;color:#fff;border-radius:999px;width:22px;height:22px;font-size:.7em;display:flex;align-items:center;justify-content:center;border:2px solid #fff;font-weight:800}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.86);z-index:1500;display:none}
  .overlay.show{display:block;animation:fadeIn .2s}
  .overlay .panel{max-width:540px;margin:18px auto;background:#fff;color:#333;border-radius:16px;padding:22px;position:relative}
  .close-btn{position:absolute;top:10px;right:10px;background:#ff6b6b;border:none;color:#fff;border-radius:999px;width:36px;height:36px;font-size:1.1em;cursor:pointer}
  .journal-filters{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0}
  .filter-btn{border:2px solid #667eea;background:rgba(102,126,234,.08);color:#667eea;padding:6px 10px;border-radius:999px;cursor:pointer}
  .filter-btn.active{background:#667eea;color:#fff}
  .journal-entry{background:rgba(102,126,234,.06);border-left:4px solid #667eea;padding:12px;border-radius:10px;margin-bottom:10px}
  .notification{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:rgba(255,215,0,.96);color:#333;border:2px solid #ffd700;border-radius:14px;padding:10px 14px;z-index:2000;animation:slideDown .25s ease}
  .combo-indicator{position:fixed;top:90px;right:16px;background:rgba(255,107,107,.92);border:2px solid #ff6b6b;color:#fff;border-radius:12px;padding:8px 10px;font-weight:800;z-index:1200}
  .tooltip{font-size:.85em;opacity:.85;margin-top:4px;text-align:right}
  .crit-msg{margin-top:8px;font-size:.9em}
  @media (prefers-reduced-motion: reduce){
    *{animation:none !important;transition:none !important}
  }
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
</style>
</head>
<body>
<div class="game-container">
  <!-- START -->
  <div id="startScreen" class="start-screen">
    <div class="header">
      <div style="font-size:3.2em;margin-bottom:10px">ğŸ—½</div>
      <h1>MAIKO SURVIVAL NYC</h1>
      <div class="sub">Version Ã©quilibrÃ©e & difficile</div>
    </div>
    <div class="start-box">
      <div><strong>Choisis la difficultÃ©</strong></div>
      <div class="select" id="diffSelect">
        <button class="pill" data-diff="easy">Facile</button>
        <button class="pill active" data-diff="normal">Normal</button>
        <button class="pill" data-diff="hard">Difficile</button>
      </div>
      <div style="margin-top:8px;font-size:.95em;opacity:.9">
        <div>â€¢ Prix & taxes rÃ©elles Â· faim naturelle Â· fatigue progressive</div>
        <div>â€¢ Rares moins â€œOPâ€, punition des mauvais enchaÃ®nements</div>
      </div>
      <button class="start-btn" id="startBtn">ğŸš€ DÃ©marrer</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="gameScreen" class="hidden">
    <div class="header">
      <h1>ğŸ—½ MAIKO Ã€ NYC</h1>
      <div class="sub">DifficultÃ©: <span id="diffLabel">Normal</span></div>
      <div class="mood-indicator" id="moodIcon">ğŸ˜Š</div>
    </div>
    <div class="row topline">
      <div class="day-counter">Jour <b id="day">1</b>/5</div>
      <div class="turns">Actions restantes: <b id="turnsLeft">8</b>/8</div>
    </div>

    <div class="stats-container">
      <div class="stat">
        <div class="stat-label" id="moneyLabel"><span>ğŸ’° Argent</span><span><b id="money">300</b>$</span></div>
        <div class="stat-bar"><div class="stat-fill money-fill" id="moneyBar" style="width:100%"></div></div>
      </div>
      <div class="stat">
        <div class="stat-label" id="energyLabel"><span>âš¡ Ã‰nergie</span><span><b id="energy">100</b>%</span></div>
        <div class="stat-bar"><div class="stat-fill energy-fill" id="energyBar" style="width:100%"></div></div>
      </div>
      <div class="stat">
        <div class="stat-label" id="hungerLabel"><span>ğŸ” Faim</span><span><b id="hunger">40</b>%</span></div>
        <div class="stat-bar"><div class="stat-fill hunger-fill" id="hungerBar" style="width:40%"></div></div>
      </div>
      <div class="stat">
        <div class="stat-label" id="patienceLabel"><span>ğŸ˜¤ Patience</span><span><b id="patience">100</b>%</span></div>
        <div class="stat-bar"><div class="stat-fill patience-fill" id="patienceBar" style="width:100%"></div></div>
      </div>
      <div class="stat">
        <div class="stat-label" id="yamyLabel"><span>ğŸ’• Yamy</span><span><b id="yamy">100</b>%</span></div>
        <div class="stat-bar"><div class="stat-fill yamy-fill" id="yamyBar" style="width:100%"></div></div>
      </div>
      <div id="critBox" class="crit-msg"></div>
    </div>

    <div id="eventContainer"></div>
  </div>

  <!-- GAME OVER -->
  <div id="gameOverScreen" class="hidden game-over">
    <h2>ğŸ’€ GAME OVER ğŸ’€</h2>
    <div id="gameOverReason" style="margin:10px 0 6px"></div>
    <div class="start-box" style="color:#333">
      <div><b>Jours:</b> <span id="finalDays">0</span></div>
      <div><b>Actions:</b> <span id="finalActions">0</span></div>
      <div><b>Argent:</b> $<span id="finalMoney">0</span></div>
      <div><b>Photos:</b> <span id="finalPhotos">0</span></div>
      <div><b>Achievements:</b> <span id="finalAchievements">0</span>/25</div>
    </div>
    <button class="restart-btn" id="restartBtn">ğŸ”„ Recommencer</button>
  </div>

  <!-- NAV -->
  <div id="bottomNav" class="bottom-nav hidden">
    <button class="nav-btn" id="journalBtn" title="J">ğŸ“”<span class="badge-count" id="journalBadge">0</span></button>
    <button class="nav-btn" id="achievementsBtn" title="A">ğŸ†<span class="badge-count" id="achievementsBadge">0</span></button>
    <button class="nav-btn" id="statsBtn" title="S">ğŸ“Š</button>
    <button class="nav-btn" id="soundBtn" title="Son">ğŸ”‡</button>
  </div>
</div>

<!-- Overlays -->
<div id="journalOverlay" class="overlay"><div class="panel">
  <button class="close-btn" data-close>Ã—</button>
  <h2 style="color:#667eea;text-align:center">ğŸ“” Journal</h2>
  <div class="journal-filters" id="filters">
    <button class="filter-btn active" data-filter="all">Tout</button>
    <button class="filter-btn" data-filter="yamy">ğŸ’• Yamy</button>
    <button class="filter-btn" data-filter="food">ğŸ” Bouffe</button>
    <button class="filter-btn" data-filter="photos">ğŸ“¸ Photos</button>
    <button class="filter-btn" data-filter="mood">ğŸ˜¤ Mood</button>
  </div>
  <div id="journalStats" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:8px;font-size:.95em"></div>
  <div id="journalEntries"></div>
</div></div>

<div id="achievementsOverlay" class="overlay"><div class="panel">
  <button class="close-btn" data-close>Ã—</button>
  <h2 style="color:#667eea;text-align:center">ğŸ† Achievements</h2>
  <div id="achievementsList"></div>
</div></div>

<div id="statsOverlay" class="overlay"><div class="panel">
  <button class="close-btn" data-close>Ã—</button>
  <h2 style="color:#667eea;text-align:center">ğŸ“Š Statistiques</h2>
  <div id="statsHistory"></div>
  <div id="spendingBreakdown" style="margin-top:12px"></div>
  <div id="generalStats" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px"></div>
</div></div>

<div id="notificationContainer"></div>
<div id="comboIndicator" class="combo-indicator hidden">
  ğŸ”¥ COMBO <span id="comboX">x1</span>
  <div class="tooltip">Bonus positifs +5% par niveau</div>
</div>

<script>
/* ================== SETTINGS & UTILS ================== */
const TAX = 0.08875; // NYC sales tax approx
const TIP_MIN = 0.10, TIP_MAX = 0.20; // typical tips on food
const DAY_ACTIONS = 8;

const DIFFS = {
  easy:   { label:'Facile',  price:0.95, hungerTick:5, energyDaily:0, yamyWear:2, rareBuff:1.0 },
  normal: { label:'Normal',  price:1.00, hungerTick:7, energyDaily:2, yamyWear:3, rareBuff:1.0 },
  hard:   { label:'Difficile', price:1.15, hungerTick:10, energyDaily:4, yamyWear:5, rareBuff:1.15 }
};

let soundEnabled = JSON.parse(localStorage.getItem('msnyc_sound')||'false');
let selectedDiff = localStorage.getItem('msnyc_diff') || 'normal';

function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
function vibrate(ms=50){ if('vibrate' in navigator) navigator.vibrate(ms); }
function fmt(n){ return Math.round(n); }
function showNote(icon, text){
  const n = document.createElement('div');
  n.className='notification'; n.innerHTML=`<b style="margin-right:6px">${icon}</b>${text}`;
  document.getElementById('notificationContainer').appendChild(n);
  setTimeout(()=>n.remove(), 2500);
}

/* ================== AUDIO ================== */
const sounds = {
  click: () => play(500, .08, .05),
  success: () => play(820, .12, .09),
  fail: () => play(220, .14, .1),
  achievement: () => { play(600,.08,.06); setTimeout(()=>play(820,.08,.06),100); setTimeout(()=>play(1000,.12,.08),220); }
};
function play(freq, duration, volume){
  if(!soundEnabled) return;
  try{
    const Ctx = window.AudioContext||window.webkitAudioContext;
    if(!Ctx) return;
    const ctx = new Ctx(), osc=ctx.createOscillator(), g=ctx.createGain();
    osc.connect(g); g.connect(ctx.destination);
    osc.frequency.value=freq; g.gain.value=volume;
    osc.start(); osc.stop(ctx.currentTime+duration);
  }catch(e){}
}

/* ================== STATE ================== */
const game = {
  state: { day:1, actionCount:0, money:300, energy:100, hunger:40, patience:100, yamy:100, photos:0, maxMoney:300, combo:0, lastChoiceType:null, statsHistory:[] },
  journal: [], achievements: [], usedEvents: [], availableEvents: [], currentFilter:'all',
  spending: { food:0, transport:0, culture:0, shopping:0, other:0 },
  energyStreak:0, patienceStreak:0, daySpending:0, miniGamesWon:0, walkCount:0, metroCount:0, kevinAvoidCount:0
};

/* ================== DATA (quotes / achievements / events) ================== */
const quotes = {
  hungry:["Je vais croquer un taxi lÃ ","Mon ventre crie au secours","Jâ€™ai des Ã©toiles devant les yeux","Tout est nourriture autour de moi"],
  tired:["Mes jambes sont en carton","Sieste sur un trottoir ok?","Jâ€™ai clignÃ© trop longtemps -> dodo","Je marche en pilote auto"],
  broke:["NYC mâ€™a rackettÃ©e","Je vais vendre mes chaussures","Budget Ã©vaporÃ©","Note Ã  moi-mÃªme: plus jamais"],
  impatient:["Ne me parlez pas merci","Je deviens allergique aux gens","Profs = boss de fin","Je boude activement"],
  happy:["Ok câ€™est stylÃ© de ouf","Câ€™est exactement comme dans les films","Je kiffe cette journÃ©e","Le mood est au vert"],
  photos:["Mon stockage pleure","Encore une, juste uneâ€¦","La lumiÃ¨re est insane","Je suis la paparazzi de moi-mÃªme"],
  food:["Tout est XXL ici","Beurre + sucre + friture = ğŸ‡ºğŸ‡¸","Rien ne bat un bon ramen","Je rÃªve de lÃ©gumes"],
  nyc:["NYC est une machine Ã  fatigue","Bruyant, grand, vivant","Je comprends le mythe","Clermont me manque un peu"],
  group:["Le groupe traÃ®ne les pieds","On sâ€™est quand mÃªme marrÃ©s","Tout le monde rÃ¢le en chÅ“ur","Photo de groupe ratÃ©e x12"],
  yamy:["Yamy me manque","SpammÃ© de cÅ“urs (pardon)","Une peluche pour Yamy?","Je veux lui raconter tout"],
  missYamy:["Le manque commence Ã  piquer","Je veux juste un cÃ¢lin lÃ ","Le dÃ©calage me nargue","Reviens vite pls"]
};

const achievementsList = [
  {id:'first_day', icon:'ğŸ—“ï¸', title:'Premier Jour', desc:'Survivre au jour 1', condition:()=>game.state.day>=2},
  {id:'survivor', icon:'ğŸ†', title:'Survivor', desc:'Terminer le voyage', condition:()=>game.state.day>5},
  {id:'broke', icon:'ğŸ’¸', title:'FauchÃ©e', desc:'Avoir moins de 50$', condition:()=>game.state.money<50},
  {id:'rich', icon:'ğŸ’°', title:'Ã‰conome', desc:'Finir avec plus de 200$', condition:()=>game.state.day>5 && game.state.money>200},
  {id:'photographer', icon:'ğŸ“¸', title:'Photographe', desc:'Prendre 50 photos', condition:()=>game.state.photos>=50},
  {id:'paparazzi', icon:'ğŸ“·', title:'Paparazzi', desc:'Prendre 100 photos', condition:()=>game.state.photos>=100},
  {id:'foodie', icon:'ğŸ”', title:'Foodie', desc:'Manger 10 fois', condition:()=>game.journal.filter(e=>e.category==='food').length>=10},
  {id:'starving', icon:'ğŸ˜µ', title:'AffamÃ©e', desc:'Avoir 90%+ de faim', condition:()=>game.state.hunger>=90},
  {id:'energizer', icon:'âš¡', title:'Ã‰nergique', desc:'80%+ Ã©nergie 5 actions', condition:()=>false},
  {id:'zen', icon:'ğŸ§˜', title:'Zen Master', desc:'90%+ patience un jour', condition:()=>false},
  {id:'love_birds', icon:'ğŸ’•', title:'Love Birds', desc:'Yamy 90%+ longtemps', condition:()=>game.state.yamy>=90 && game.state.actionCount>10},
  {id:'heartbroken', icon:'ğŸ’”', title:'Heartbroken', desc:'Yamy â‰¤ 20%', condition:()=>game.state.yamy<=20},
  {id:'labubu', icon:'ğŸ§¸', title:'Best GF', desc:'Acheter le Labubu', condition:()=>false},
  {id:'spender', icon:'ğŸ’³', title:'DÃ©pensiÃ¨re', desc:'300$ en un jour', condition:()=>false},
  {id:'walker', icon:'ğŸš¶â€â™€ï¸', title:'Marcheuse', desc:'Refuser 5 transports', condition:()=>false},
  {id:'metro_master', icon:'ğŸš‡', title:'Metro Master', desc:'10 mÃ©tros', condition:()=>false},
  {id:'tourist', icon:'ğŸ—½', title:'Touriste Ultime', desc:'Spots iconiques', condition:()=>false},
  {id:'combo_master', icon:'ğŸ”¥', title:'Combo Master', desc:'Combo x5', condition:()=>false},
  {id:'lucky', icon:'ğŸ€', title:'Chanceuse', desc:'Ã‰vÃ¨nement rare', condition:()=>false},
  {id:'minigame_master', icon:'ğŸ®', title:'Mini-jeu Pro', desc:'3 mini-jeux', condition:()=>false},
  {id:'photo_perfectionist', icon:'ğŸ“¸', title:'Perfectionniste Photo', desc:'Photo parfaite', condition:()=>false},
  {id:'negotiator', icon:'ğŸ’°', title:'NÃ©gociatrice', desc:'NÃ©gociation ok', condition:()=>false},
  {id:'journal_writer', icon:'ğŸ“”', title:'Ã‰crivaine', desc:'30 entrÃ©es', condition:()=>game.journal.length>=30},
  {id:'balanced', icon:'âš–ï¸', title:'Ã‰quilibrÃ©e', desc:'Stats >50% en fin', condition:()=>game.state.day>5 && game.state.money>100 && game.state.energy>50 && game.state.hunger<50 && game.state.patience>50 && game.state.yamy>50},
  {id:'perfectionist', icon:'ğŸ’', title:'Perfectionniste', desc:'Stats >70% en fin', condition:()=>game.state.day>5 && game.state.energy>70 && game.state.hunger<30 && game.state.patience>70 && game.state.yamy>70}
];

const baseEvents = [
  {emoji:"ğŸ•",title:"Pizzeria",desc:"Pizzeria chÃ¨re. Maiko a FAIM.",category:'food',
   choices:[{text:"ğŸ• Part (8$)",cost:8,effects:{hunger:-25,energy:+4}},{text:"ğŸš« Refuser",effects:{hunger:+8,patience:-10}}]},
  {emoji:"â˜•",title:"Starbucks",desc:"CafÃ© pour tenir.",category:'food',
   choices:[{text:"â˜• Latte (6.5$)",cost:6.5,effects:{energy:+14,patience:+6}},{text:"ğŸ’§ Eau",effects:{energy:+3,patience:-6}}]},
  {emoji:"ğŸš¶â€â™€ï¸",title:"Marche 2h",desc:"Le prof veut marcher longtemps.",category:'transport',
   choices:[{text:"ğŸš‡ MÃ©tro (3$)",cost:3,effects:{energy:+6,patience:-6}},{text:"ğŸ‘Ÿ Marcher",effects:{energy:-18,patience:-10}}]},
  {emoji:"ğŸ¥¢",title:"Resto Asiat",desc:"ENFIN de la vraie bouffe.",category:'food',
   choices:[{text:"ğŸœ Bol (15$)",cost:15,effects:{hunger:-32,patience:+14,energy:+6}},{text:"ğŸ” Fast-food",effects:{hunger:-10,patience:-10}}]},
  {emoji:"ğŸ“¸",title:"Spot Instagram",desc:"Endroit parfait.",category:'photos',
   choices:[{text:"ğŸ“± 50 photos",effects:{energy:-10,patience:+6,photos:+8}},{text:"â­ï¸ Skip",effects:{patience:-10}}]},
  {emoji:"ğŸ˜¤",title:"Kevin Relou",desc:"Kevin la saoule.",category:'mood',
   choices:[{text:"ğŸ® Changer de groupe",effects:{patience:+10,energy:-4}},{text:"ğŸ˜¡ Le remettre",effects:{patience:-10,energy:-10}}]},
  {emoji:"ğŸ§‹",title:"Bubble Tea",desc:"Envie de sucre.",category:'food',
   choices:[{text:"ğŸ§‹ Boisson (6$)",cost:6,effects:{patience:+10,hunger:-5}},{text:"ğŸš« Passer",effects:{patience:-10}}]},
  {emoji:"ğŸŒ†",title:"Times Square Nuit",desc:"IlluminÃ© !",category:'photos',
   choices:[{text:"ğŸ“¸ 1h photos",effects:{energy:-16,patience:-6,photos:+18},achievement:'paparazzi'},{text:"ğŸƒâ€â™€ï¸ Vite",effects:{energy:-3,patience:-10,photos:+4}}]},
  // Yamy
  {emoji:"ğŸ§¸",title:"Labubu Shop",desc:"Peluche pour Yamy ?",category:'yamy',
   choices:[{text:"ğŸ’ Acheter (35$)",cost:35,effects:{patience:+14,energy:+6,yamy:+26},achievement:'labubu'},{text:"ğŸ’¸ Trop cher",effects:{patience:-12,yamy:-10}}]},
  {emoji:"ğŸ¥¨",title:"Stand de Pretzels",desc:"Odeur de pretzels chauds.",category:"food",
    choices:[{text:"ğŸ¥¨ Pretzel (4$)",cost:4,effects:{hunger:-10,patience:+4}},
             {text:"ğŸš« Passer",effects:{patience:-4}}]},
  {emoji:"ğŸ©",title:"Doughnut Shop",desc:"Vitrine qui brille.",category:"food",
    choices:[{text:"ğŸ© Donut (3.5$)",cost:3.5,effects:{hunger:-8,energy:+4}},
             {text:"â˜• + Donut (7$)",cost:7,effects:{hunger:-10,energy:+10}}]},
  {emoji:"ğŸœ",title:"Food Court",desc:"Trop de choix.",category:"food",
    choices:[{text:"ğŸ› Plat (12$)",cost:12,effects:{hunger:-24,patience:+6}},
             {text:"ğŸ¥— Salade (10$)",cost:10,effects:{hunger:-18,energy:+4}}]},
  {emoji:"ğŸ•",title:"Dollar Slice Line",desc:"Queue pour la pizza Ã  1$.",category:"food",
    choices:[{text:"â³ Attendre (1$)",cost:1,effects:{hunger:-10,patience:-6}},
             {text:"ğŸ’¸ Pizzeria voisine (9$)",cost:9,effects:{hunger:-18,patience:+6}}]},
  {emoji:"ğŸ£",title:"Sushis rapides",desc:"Bar Ã  sushis sur place.",category:"food",
    choices:[{text:"ğŸ£ 6 piÃ¨ces (14$)",cost:14,effects:{hunger:-22,energy:+4}},
             {text:"ğŸš« Trop cher",effects:{patience:-6}}]},
  {emoji:"ğŸŒ¯",title:"Food Truck Mexicain",desc:"Tacos qui sentent bon.",category:"food",
    choices:[{text:"ğŸŒ® 2 tacos (9$)",cost:9,effects:{hunger:-16,patience:+4}},
             {text:"ğŸŒ¯ Burrito (12$)",cost:12,effects:{hunger:-24,energy:+4}}]},
  {emoji:"ğŸ¥¤",title:"Bodega drink",desc:"Boisson fraÃ®che au coin.",category:"food",
    choices:[{text:"ğŸ¥¤ Soda (2.5$)",cost:2.5,effects:{energy:+4}},
             {text:"ğŸš° Eau du robinet",effects:{patience:-4}}]},
  {emoji:"ğŸ§ƒ",title:"Jus frais",desc:"Jus pressÃ© minute.",category:"food",
    choices:[{text:"ğŸŠ Jus (6$)",cost:6,effects:{energy:+8,patience:+4}},
             {text:"ğŸš« Non merci",effects:{patience:-4}}]},
  {emoji:"ğŸŸ",title:"Frites croustillantes",desc:"Frites dorÃ©es, sel gant.",category:"food",
    choices:[{text:"ğŸŸ Petite (5$)",cost:5,effects:{hunger:-10}},
             {text:"ğŸŸ Grande (7$)",cost:7,effects:{hunger:-16,patience:+4}}]},
  {emoji:"ğŸ”",title:"Diner rÃ©tro",desc:"SiÃ¨ges rouges, jukebox.",category:"food",
    choices:[{text:"ğŸ” Menu (13$)",cost:13,effects:{hunger:-26,patience:+6}},
             {text:"ğŸ³ Å’ufs & bacon (11$)",cost:11,effects:{hunger:-18,energy:+6}}]},

  {emoji:"ğŸš‡",title:"Changement ratÃ©",desc:"Tu as pris la mauvaise direction.",category:"transport",
    choices:[{text:"ğŸ§­ Recalculer (3$)",cost:3,effects:{patience:-4}},
             {text:"ğŸ‘Ÿ Marcher 25 min",effects:{energy:-10,patience:-6}}]},
  {emoji:"ğŸšŒ",title:"Bus MTA bondÃ©",desc:"Quasi pas de place assise.",category:"transport",
    choices:[{text:"ğŸšŒ Serrer les coudes (2.9$)",cost:2.9,effects:{energy:+2,patience:-8}},
             {text:"ğŸš• Prendre taxi (18$)",cost:18,effects:{energy:+10,patience:+8,photos:+2}}]},
  {emoji:"ğŸ›´",title:"Trottinette partagÃ©e",desc:"Rapide mais stressant.",category:"transport",
    choices:[{text:"ğŸ›´ Louer (6$)",cost:6,effects:{energy:+6,patience:-4}},
             {text:"ğŸš¶â€â™€ï¸ Ã€ pied",effects:{energy:-12}}]},
  {emoji:"â›´ï¸",title:"Staten Island Ferry",desc:"Vue gratuite sur la baie.",category:"transport",
    choices:[{text:"â›´ï¸ Embarquer (0$)",effects:{energy:-2,patience:+6,photos:+4}},
             {text:"ğŸš« Pas le temps",effects:{patience:-6}}]},
  {emoji:"ğŸš¦",title:"Feu rouge interminable",desc:"Tu attends, attendsâ€¦",category:"transport",
    choices:[{text:"ğŸš¶â€â™€ï¸ Traverser plus loin",effects:{energy:-6,patience:-4}},
             {text:"ğŸ§ Attendre",effects:{patience:-6}}]},

  {emoji:"ğŸŸï¸",title:"Billet musÃ©e",desc:"EntrÃ©e standard ou Ã©tudiante ?.",category:"culture",
    choices:[{text:"ğŸŸï¸ Ã‰tudiant (12$)",cost:12,effects:{patience:+8,energy:-6,photos:+4}},
             {text:"ğŸš« Passer",effects:{patience:-6}}]},
  {emoji:"ğŸ–¼ï¸",title:"Galerie de SoHo",desc:"Expo Ã©phÃ©mÃ¨re.",category:"culture",
    choices:[{text:"ğŸ¨ Entrer (8$)",cost:8,effects:{patience:+8,photos:+3}},
             {text:"ğŸ“· Vitre seulement",effects:{photos:+1}}]},
  {emoji:"ğŸ­",title:"Impro de rue",desc:"Spectacle drÃ´le.",category:"culture",
    choices:[{text:"ğŸ’µ Tip (2$)",cost:2,effects:{patience:+6}},
             {text:"ğŸ‘ Applaudir",effects:{patience:+2}}]},
  {emoji:"ğŸ“š",title:"Librairie culte",desc:"Odeur de papier.",category:"culture",
    choices:[{text:"ğŸ“– Carnet (9$)",cost:9,effects:{patience:+6,photos:+1}},
             {text:"ğŸ‘€ FlÃ¢ner",effects:{patience:+2}}]},
  {emoji:"ğŸ¶",title:"Concert de rue",desc:"Jazz Ã  Bryant Park.",category:"culture",
    choices:[{text:"ğŸ¶ Rester 20 min",effects:{energy:-4,patience:+8,photos:+2}},
             {text:"ğŸš¶â€â™€ï¸ Continuer",effects:{patience:-4}}]},

  {emoji:"ğŸ˜µâ€ğŸ’«",title:"Trop de bruit",desc:"Klaxons + sirÃ¨nes = ğŸ¤¯",category:"mood",
    choices:[{text:"ğŸ§ Musique (3$)",cost:3,effects:{patience:+8}},
             {text:"ğŸ§˜ Respiration",effects:{patience:+4}}]},
  {emoji:"ğŸ˜ ",title:"Groupe en retard",desc:"Encore 15 minutesâ€¦",category:"mood",
    choices:[{text:"ğŸ—“ï¸ Replanifier",effects:{patience:+2}},
             {text:"ğŸ˜¤ Remontrance",effects:{patience:-8,energy:-4}}]},
  {emoji:"ğŸ¤³",title:"Selfie fail",desc:"Yeux fermÃ©s, encore.",category:"photos",
    choices:[{text:"ğŸ¤³ Re-tenter",effects:{photos:+3,energy:-4}},
             {text:"ğŸ“¸ Demander aide",effects:{photos:+4,patience:+2}}]},
  {emoji:"ğŸ—ºï¸",title:"Perdue 5 min",desc:"GPS capricieux.",category:"mood",
    choices:[{text:"ğŸ—ºï¸ Recalibrer",effects:{patience:-2}},
             {text:"ğŸ‘® Demander un agent",effects:{patience:+2}}]},
  {emoji:"ğŸ§¼",title:"Salle de bain introuvable",desc:"Urgence augmente.",category:"mood",
    choices:[{text:"â˜• Acheter (2.5$)",cost:2.5,effects:{patience:+6}},
             {text:"ğŸš¶â€â™€ï¸ Chercher encore",effects:{energy:-6,patience:-6}}]},

  {emoji:"ğŸ§£",title:"Souvenir bonnet NYC",desc:"StylÃ© mais utile ?",category:"shopping",
    choices:[{text:"ğŸ§£ Acheter (15$)",cost:15,effects:{patience:+6,yamy:+4}},
             {text:"ğŸ’¸ Trop cher",effects:{patience:-4}}]},
  {emoji:"ğŸ‘Ÿ",title:"Semelles gel",desc:"Pieds en feu.",category:"shopping",
    choices:[{text:"ğŸ‘Ÿ Acheter (10$)",cost:10,effects:{energy:+10,patience:+4}},
             {text:"ğŸ’ª Tenir",effects:{energy:-6,patience:-4}}]},
  {emoji:"ğŸ§´",title:"CrÃ¨me solaire",desc:"UV costauds aujourdâ€™hui.",category:"shopping",
    choices:[{text:"ğŸ§´ SPF (7$)",cost:7,effects:{energy:+2,patience:+2}},
             {text:"ğŸ˜‘ Sans",effects:{energy:-4}}]},
  {emoji:"ğŸ’",title:"Bretelles sac",desc:"Une sâ€™est cassÃ©e.",category:"shopping",
    choices:[{text:"ğŸ§µ RÃ©parer (6$)",cost:6,effects:{energy:+4}},
             {text:"ğŸ–ï¸ Porter Ã  la main",effects:{energy:-10}}]},
  {emoji:"ğŸ“¦",title:"Casiers de gare",desc:"DÃ©poser des sacs.",category:"shopping",
    choices:[{text:"ğŸ”’ Louer (5$)",cost:5,effects:{energy:+6}},
             {text:"ğŸ’¼ Garder sur soi",effects:{energy:-8}}]},
  {emoji:"ğŸ“±",title:"Appel Yamy",desc:"Un appel ? ",category:'yamy',
   choices:[{text:"ğŸ’• 20 min",effects:{energy:-6,patience:+14,yamy:+18}},{text:"â±ï¸ Rapide",effects:{yamy:-10,patience:-8}}]}
];

const conditionals = [
  {emoji:"ğŸ˜´",title:"Sieste",desc:"Elle vacilleâ€¦",category:'energy',condition:()=>game.state.energy<35,
   choices:[{text:"ğŸ’¤ Dormir 1h",effects:{energy:+28,hunger:+12,yamy:-4}},{text:"â˜• CafÃ© (8$)",cost:8,effects:{energy:+14}}]},
  {emoji:"ğŸ•",title:"Pizza Ã  1$",desc:"Plan radin.",category:'food',condition:()=>game.state.money<100,
   choices:[{text:"ğŸ• Slice (1$)",cost:1,effects:{hunger:-12}},{text:"ğŸš« Rien",effects:{hunger:+8}}]},
   {emoji:"ğŸŒ§ï¸",title:"Averse soudaine",desc:"Pas de parapluie.",category:"weather",
   condition:()=> game.state.energy>0 && game.state.hunger<90,
   choices:[{text:"â˜‚ï¸ Acheter (12$)",cost:12,effects:{patience:+6}},
            {text:"ğŸ’¦ Courir",effects:{energy:-10,patience:-10}}]},
  {emoji:"ğŸ”¥",title:"Trop chaud",desc:"Canicule Ã©crasante.",category:"weather",
   condition:()=> game.state.energy<70,
   choices:[{text:"ğŸ¥¤ Boisson glacÃ©e (5$)",cost:5,effects:{energy:+8,patience:+4}},
            {text:"ğŸŒ³ Ombre 10 min",effects:{energy:+4}}]},
  {emoji:"ğŸ§Š",title:"Clim glaciale",desc:"Dans le mÃ©tro.",category:"weather",
   condition:()=> game.state.energy<60,
   choices:[{text:"ğŸ§£ Acheter (8$)",cost:8,effects:{energy:+6}},
            {text:"ğŸ¥¶ Supporter",effects:{energy:-6,patience:-4}}]},
  {emoji:"ğŸ•˜",title:"Retard de 30 min",desc:"Planning dÃ©calÃ©.",category:"mood",
   condition:()=> game.state.patience<60,
   choices:[{text:"ğŸ—‚ï¸ RÃ©organiser",effects:{patience:+4}},
            {text:"ğŸ˜’ RÃ¢ler",effects:{patience:-8}}]},
  {emoji:"ğŸ’¤",title:"Coup de barre",desc:"PaupiÃ¨res lourdes.",category:"energy",
   condition:()=> game.state.energy<40,
   choices:[{text:"â˜• Double shot (7$)",cost:7,effects:{energy:+16}},
            {text:"ğŸ˜®â€ğŸ’¨ Ã‰tirements",effects:{energy:+6}}]},
  {emoji:"ğŸ§ƒ",title:"Hypo lÃ©gÃ¨re",desc:"Tu trembles un peu.",category:"food",
   condition:()=> game.state.hunger>65 && game.state.energy<50,
   choices:[{text:"ğŸ« Barre (3$)",cost:3,effects:{hunger:-8,energy:+8}},
            {text:"ğŸ Pomme (2$)",cost:2,effects:{hunger:-6}}]},
  {emoji:"ğŸ“±",title:"Batterie 10%",desc:"TÃ©lÃ©phone proche KO.",category:"other",
   condition:()=> game.state.photos>10,
   choices:[{text:"ğŸ”Œ Powerbank (18$)",cost:18,effects:{patience:+6}},
            {text:"ğŸ” Spot prise",effects:{energy:-6,patience:-4}}]},
  {emoji:"ğŸ§¦",title:"Ampoule au pied",desc:"AÃ¯e Ã  chaque pas.",category:"mood",
   condition:()=> game.state.energy<70,
   choices:[{text:"ğŸ§¦ Chaussettes (6$)",cost:6,effects:{energy:+6}},
            {text:"ğŸ˜£ Ignorer",effects:{energy:-8,patience:-4}}]},
  {emoji:"ğŸ§´",title:"Mains sÃ¨ches",desc:"Air climâ€™ + gel hydro.",category:"other",
   condition:()=> true,
   choices:[{text:"ğŸ§´ CrÃ¨me (4$)",cost:4,effects:{patience:+4}},
            {text:"ğŸ¤· Rien",effects:{}}]},
  {emoji:"ğŸ•",title:"DÃ©calage pique",desc:"Somnolence hors horaire.",category:"energy",
   condition:()=> game.state.day<=2 && game.state.energy<60,
   choices:[{text:"ğŸ˜´ Micro-sieste 15min",effects:{energy:+10,hunger:+4,yamy:-2}},
            {text:"ğŸš¶ Bouger",effects:{energy:+4}}]},
  {emoji:"ğŸ˜®â€ğŸ’¨",title:"Stress du groupe",desc:"Trop de bruit, trop vite.",category:"mood",
   condition:()=> game.state.patience<50,
   choices:[{text:"ğŸ§˜ 4-7-8",effects:{patience:+8}},
            {text:"ğŸ§ Isolement",effects:{patience:+6,energy:+2}}]},
  {emoji:"ğŸ§ƒ",title:"Sirop dâ€™Ã©rable tentant",desc:"Boutique souvenir.",category:"shopping",
   condition:()=> game.state.money>40,
   choices:[{text:"ğŸ Petit flacon (8$)",cost:8,effects:{yamy:+4,patience:+4}},
            {text:"ğŸš« Câ€™est lourd",effects:{patience:-2}}]},
  {emoji:"ğŸ§¸",title:"Peluche alternative",desc:"Kitsch mais drÃ´le.",category:"yamy",
   condition:()=> !game.achievements.includes('labubu'),
   choices:[{text:"ğŸ§¸ (20$)",cost:20,effects:{yamy:+12,patience:+4}},
            {text:"ğŸ“· Photo Ã  la place",effects:{photos:+2}}]},
  {emoji:"ğŸ“…",title:"Planning compressÃ©",desc:"Deux spots Ã  caser.",category:"mood",
   condition:()=> game.state.day>=3,
   choices:[{text:"ğŸƒâ€â™€ï¸ AccÃ©lÃ©rer",effects:{energy:-8,patience:-4}},
            {text:"âŒ Annuler un spot",effects:{patience:+4}}]},
  {emoji:"ğŸ§¼",title:"Tache sur t-shirt",desc:"Photo tout Ã  lâ€™heureâ€¦",category:"other",
   condition:()=> game.state.photos>15,
   choices:[{text:"ğŸ‘• T-shirt (12$)",cost:12,effects:{patience:+6}},
            {text:"ğŸ§» Nettoyer vite",effects:{patience:+2}}]},
  {emoji:"ğŸ’°",title:"ATM",desc:"Besoin de cash ?",category:'money',condition:()=>game.state.money<50,
   choices:[{text:"ğŸ’µ 50$ (+5$ frais)",cost: -45, effects:{}},{text:"âŒ Continuer",effects:{patience:-6}}]} // cost nÃ©gative = gain net
];

const rares = [
  {emoji:"â­",title:"CÃ©lÃ©britÃ©!",desc:"CroisÃ©e au coin de la rue.",category:'rare',
   choices:[{text:"ğŸ“± Photo",effects:{energy:-4,patience:+18,photos:+4}},{text:"ğŸ‘€ Laisser",effects:{patience:-10}}],achievement:'lucky'},
  {emoji:"ğŸ’¼",title:"Portefeuille rendu",desc:"Quelquâ€™un te rend un portefeuille perdu.",category:"rare",
    choices:[{text:"ğŸ’µ RÃ©compense",effects:{money:+40,patience:+10}},
             {text:"ğŸ™ Juste merci",effects:{patience:+12}}],achievement:"lucky"},
  {emoji:"ğŸŸï¸",title:"EntrÃ©es comp offertes",desc:"Tu tombes sur une disrib dâ€™invitations.",category:"rare",
    choices:[{text:"ğŸ­ Spectacle",effects:{patience:+14,photos:+4,energy:-6}},
             {text:"ğŸ¶ Concert",effects:{patience:+12,photos:+6,energy:-8}}],achievement:"lucky"},
  {emoji:"ğŸ§¾",title:"Erreur de caisse",desc:"Le total est plus bas quâ€™affichÃ©.",category:"rare",
    choices:[{text:"âœ… Payer moins",effects:{money:+10,patience:+8}},
             {text:"ğŸ¤ Signaler",effects:{patience:+10}}],achievement:"lucky"},
  {emoji:"ğŸ“¸",title:"Ciel incroyable",desc:"Golden hour parfaite.",category:"rare",
    choices:[{text:"ğŸ“¸ Mitrailler",effects:{photos:+12,energy:-6,patience:+8}},
             {text:"ğŸ‘€ Profiter",effects:{patience:+10}}],achievement:"lucky"},
  {emoji:"ğŸ—½",title:"Guide super sympa",desc:"Te file 2 astuces secrÃ¨tes.",category:"rare",
    choices:[{text:"ğŸ“ Spot secret",effects:{photos:+8,patience:+10}},
             {text:"ğŸ’¸ Bon plan -5$",effects:{money:+5,patience:+6}}],achievement:"lucky"},
  {emoji:"ğŸ",title:"Goodie bag",desc:"Samples gratuits.",category:"rare",
    choices:[{text:"ğŸ Prendre",effects:{patience:+8,energy:+4}},
             {text:"ğŸ‘‹ Laisser",effects:{}}],achievement:"lucky"},
  {emoji:"ğŸš•",title:"Taxi offre la course",desc:"Histoire improbable mais vrai.",category:"rare",
    choices:[{text:"ğŸš• Monter",effects:{energy:+12,patience:+10}},
             {text:"ğŸš¶â€â™€ï¸ Refuser",effects:{}}],achievement:"lucky"},
  {emoji:"ğŸ’³",title:"Cashback Ã©clair",desc:"Promo bancaire furtive.",category:"rare",
    choices:[{text:"ğŸ’³ Activer",effects:{money:+15,patience:+6}},
             {text:"â­ï¸ Ignorer",effects:{}}],achievement:"lucky"},
  {emoji:"ğŸ“±",title:"Wifi public turbo",desc:"Upload tes stories instant.",category:"rare",
    choices:[{text:"ğŸš€ Spam stories",effects:{photos:+8,patience:+6,energy:-4}},
             {text:"ğŸ‘ Sobre",effects:{patience:+4}}],achievement:"lucky"},
  {emoji:"ğŸ•Šï¸",title:"Hasard bienveillant",desc:"Quelquâ€™un tâ€™aide sans demander.",category:"rare",
    choices:[{text:"ğŸ˜Š Remercier",effects:{patience:+12}},
             {text:"ğŸ™ + Tip (2$)",cost:2,effects:{patience:+16}}],achievement:"lucky"},
  {emoji:"ğŸ’¸",title:"50$ trouvÃ©s",desc:"Par terreâ€¦",category:'rare',
   choices:[{text:"ğŸ’° Prendre",effects:{money:+50,patience:+12}},{text:"ğŸš” Rapporter",effects:{patience:+8}}],achievement:'lucky'}
];

/* ================== PRICING (taxes & tips) ================== */
function priceWithNYC(cost, category){
  if(cost==null) return {total:0, breakdown:''};
  let base = cost;
  const diff = DIFFS[selectedDiff];
  base *= diff.price;

  let tax = base * TAX;
  let tip = 0;
  if(category==='food') tip = base * (TIP_MIN + Math.random()*(TIP_MAX-TIP_MIN));
  const total = base + tax + tip;

  return {
    total: Math.round(total*100)/100,
    breakdown: `â‰ˆ ${base.toFixed(2)}$ + tax ${tax.toFixed(2)}${tip?` + tip ${tip.toFixed(2)}`:''}`
  };
}

/* ================== JOURNAL / ACHIEVEMENTS ================== */
function moodEmoji(){
  const s=game.state;
  const avg=(s.energy + s.patience + (100-s.hunger) + s.yamy)/4;
  if(avg<25) return 'ğŸ˜­'; if(avg<40) return 'ğŸ˜«'; if(avg<60) return 'ğŸ˜'; if(avg<80) return 'ğŸ˜Š'; return 'ğŸ˜„';
}
function addJournal(title,category){
  const s=game.state;
  let q="";
  if(s.yamy<40) q = pick(quotes.missYamy);
  else if(s.hunger>70) q = pick(quotes.hungry);
  else if(s.energy<30) q = pick(quotes.tired);
  else if(s.money<50) q = pick(quotes.broke);
  else if(s.patience<30) q = pick(quotes.impatient);
  else if(category==='yamy') q = pick(quotes.yamy);
  else if(category==='food') q = pick(quotes.food);
  else if(category==='photos') q = pick(quotes.photos);
  else q = Math.random()>0.5 ? pick(quotes.nyc) : pick(quotes.group);

  game.journal.unshift({
    day:s.day,action:s.actionCount,category:category||'general',
    quote:q,money:fmt(s.money),energy:fmt(s.energy),hunger:fmt(s.hunger),
    patience:fmt(s.patience),yamy:fmt(s.yamy),
    time:new Date().toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'})
  });
  document.getElementById('journalBadge').textContent = game.journal.length;
  checkAchievements();
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function updateJournalUI(){
  const f = game.currentFilter;
  const list = f==='all'? game.journal : game.journal.filter(e=>e.category===f);
  const c = document.getElementById('journalEntries');
  if(!list.length){ c.innerHTML = `<div style="text-align:center;color:#888;padding:20px">Aucune entrÃ©e</div>`; }
  else {
    c.innerHTML = list.map(e=>`
      <div class="journal-entry">
        <div class="row" style="font-weight:700;color:#667eea"><div>Jour ${e.day} Â· Act ${e.action}</div><div>${e.time}</div></div>
        <div style="margin:4px 0;opacity:.9"><span>${emojiForCat(e.category)} ${e.category}</span></div>
        <div style="font-style:italic;margin:6px 0">${e.quote}</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;font-size:.85em;opacity:.85">
          <div style="text-align:center">ğŸ’°${e.money}</div>
          <div style="text-align:center">âš¡${e.energy}%</div>
          <div style="text-align:center">ğŸ”${e.hunger}%</div>
          <div style="text-align:center">ğŸ˜¤${e.patience}%</div>
          <div style="text-align:center">ğŸ’•${e.yamy}%</div>
        </div>
      </div>`).join('');
  }
  document.getElementById('journalStats').innerHTML = `
    <div style="text-align:center;background:rgba(102,126,234,.08);padding:8px;border-radius:10px">ğŸ—“ï¸ Jour <b>${game.state.day}</b></div>
    <div style="text-align:center;background:rgba(102,126,234,.08);padding:8px;border-radius:10px">ğŸ“ <b>${game.journal.length}</b> entrÃ©es</div>
    <div style="text-align:center;background:rgba(102,126,234,.08);padding:8px;border-radius:10px">ğŸ’° $<b>${fmt(game.state.money)}</b></div>
    <div style="text-align:center;background:rgba(102,126,234,.08);padding:8px;border-radius:10px">ğŸ“¸ <b>${game.state.photos}</b></div>`;
}
function emojiForCat(cat){ const m={yamy:'ğŸ’•',food:'ğŸ”',photos:'ğŸ“¸',mood:'ğŸ˜¤',transport:'ğŸš‡',spending:'ğŸ’³',culture:'ğŸ¨',rare:'â­',energy:'âš¡',weather:'â˜”',social:'ğŸ‘¥',fun:'ğŸ®',money:'ğŸ’°'}; return m[cat]||'ğŸ“'; }

function updateAchievementsUI(){
  const c=document.getElementById('achievementsList');
  c.innerHTML = achievementsList.map(a=>{
    const unlocked=game.achievements.includes(a.id);
    return `<div style="display:flex;gap:12px;align-items:center;padding:10px;border-left:4px solid ${unlocked?'#667eea':'#999'};background:${unlocked?'rgba(102,126,234,.06)':'rgba(0,0,0,.04)'};border-radius:10px;margin-bottom:8px;opacity:${unlocked?1:.5}">
      <div style="font-size:2em">${a.icon}</div>
      <div><div style="font-weight:800;color:#667eea">${a.title}</div><div style="opacity:.85">${a.desc}</div></div>
    </div>`;
  }).join('');
  document.getElementById('achievementsBadge').textContent = game.achievements.length;
}

function checkAchievements(){
  achievementsList.forEach(a=>{
    if(!game.achievements.includes(a.id) && a.condition && a.condition()){
      game.achievements.push(a.id);
      showNote('ğŸ…',`Achievement: ${a.title}`); sounds.achievement();
    }
  });
  updateAchievementsUI();
}

/* ================== EVENTS FLOW ================== */
function buildPool(){
  const pool = [];
  // base
  pool.push(...baseEvents);
  // conditional
  pool.push(...conditionals.filter(e=>!e.condition || e.condition()));
  // rares (faible proba)
  if(Math.random()<0.05){ // 5%
    const diff = DIFFS[selectedDiff];
    const r = pick(rares);
    if(diff.rareBuff>1 && r.choices[0].effects.patience) {
      // rendre moins "OP": on applique un petit malus sur positif si hard
      r.choices = r.choices.map(ch=>{
        const ef={...ch.effects};
        if(ef.patience) ef.patience = Math.round(ef.patience / diff.rareBuff);
        if(ef.money>0)  ef.money   = Math.round(ef.money   / diff.rareBuff);
        return {...ch, effects:ef};
      });
    }
    pool.push({...r, rare:true});
  }
  return pool;
}

function showEvent(){
  const list = buildPool();
  const e = pick(list);
  const rareClass = e.rare ? ' event-rare' : '';
  const catChip = `<div class="chip">${emojiForCat(e.category)} ${e.category}</div>`;
  const cont = document.getElementById('eventContainer');

  // Inject price previews with tax/tip
  const choicesHtml = e.choices.map((ch,i)=>{
    let effectsText = [];
    // dynamic pricing
    let priceLine = '';
    if('cost' in ch){
      const p = priceWithNYC(Math.abs(ch.cost), e.category);
      const total = ch.cost>=0 ? p.total : -p.total; // ATM â€œgainâ€
      priceLine = ch.cost>=0 ? ` Â· <span>coÃ»t rÃ©el â‰ˆ ${total.toFixed(2)}$</span>` : ` Â· <span>gain net â‰ˆ ${(-total).toFixed(2)}$</span>`;
      ch._priced = total; // cache
    }
    const ef = ch.effects||{};
    if(ef.energy) effectsText.push(`âš¡${ef.energy>0?'+':''}${ef.energy}%`);
    if(ef.hunger) effectsText.push(`ğŸ”${ef.hunger>0?'+':''}${ef.hunger}%`);
    if(ef.patience) effectsText.push(`ğŸ˜¤${ef.patience>0?'+':''}${ef.patience}%`);
    if(ef.yamy) effectsText.push(`ğŸ’•${ef.yamy>0?'+':''}${ef.yamy}%`);
    if(ef.photos) effectsText.push(`ğŸ“¸+${ef.photos}`);

    return `<button class="choice-btn" data-idx="${i}">
      <div class="choice-line"><div>${ch.text}</div><div class="mini">${priceLine}</div></div>
      <div class="effects">${effectsText.join(' Â· ') || 'â€”'}</div>
    </button>`;
  }).join('');

  cont.innerHTML = `
    <div class="event-card${rareClass}">
      <div class="event-emoji">${e.emoji}</div>
      <div class="event-title">${e.title}</div>
      ${catChip}
      <div class="event-description">${e.desc}</div>
      <div class="choices" id="choices">${choicesHtml}</div>
    </div>`;

  const btns = [...document.querySelectorAll('.choice-btn')];
  btns.forEach(b=>b.addEventListener('click', ()=>{
    btns.forEach(x=>x.disabled=true); // anti double clic
    sounds.click();
    const idx = +b.dataset.idx;
    resolveChoice(e, e.choices[idx]);
  }));

  // Keyboard shortcuts
  window.onkeydown = (ev)=>{
    if(ev.key==='1' && btns[0]) btns[0].click();
    if(ev.key==='2' && btns[1]) btns[1].click();
    if(ev.key.toLowerCase()==='j') toggleOverlay('journalOverlay', true);
    if(ev.key.toLowerCase()==='a') toggleOverlay('achievementsOverlay', true);
    if(ev.key.toLowerCase()==='s') toggleOverlay('statsOverlay', true);
  };
}

function resolveChoice(evt, ch){
  const s=game.state;
  // Combo
  if(s.lastChoiceType===evt.category){
    s.combo++;
    document.getElementById('comboIndicator').classList.remove('hidden');
    document.getElementById('comboX').textContent = `x${s.combo}`;
    if(s.combo===5 && !game.achievements.includes('combo_master')){
      game.achievements.push('combo_master'); showNote('ğŸ”¥','Achievement: Combo Master'); sounds.achievement();
    }
  } else {
    s.combo=1; document.getElementById('comboIndicator').classList.add('hidden');
  }
  s.lastChoiceType=evt.category;
  const comboBonus = s.combo>=2 ? 1 + (s.combo*0.05) : 1;
  const apply = v => v ? Math.round(v * (v>0? comboBonus:1)) : 0;

  // MONEY (with taxes)
  if('_priced' in ch){
    const delta = ch._priced; // already signed
    s.money -= delta; // cost positive decreases money; ATM negative increases
    // spending buckets
    if(delta>0){
      const amount = delta;
      if(evt.category==='food') game.spending.food+=amount;
      else if(evt.category==='transport') game.spending.transport+=amount;
      else if(evt.category==='culture') game.spending.culture+=amount;
      else if(evt.category==='spending') game.spending.shopping+=amount;
      else game.spending.other+=amount;
      game.daySpending += amount;
      if(game.daySpending>=300 && !game.achievements.includes('spender')){
        game.achievements.push('spender'); showNote('ğŸ’³','Achievement: DÃ©pensiÃ¨re'); sounds.achievement();
      }
    }
  }

  // APPLY EFFECTS
  const ef=ch.effects||{};
  s.energy   += apply(ef.energy||0);
  s.hunger   += apply(ef.hunger||0);
  s.patience += apply(ef.patience||0);
  s.yamy     += apply((ef.yamy||0) - DIFFS[selectedDiff].yamyWear); // usure relationnelle
  s.photos   += (ef.photos||0);

  // Fatigue passive par jour
  s.energy -= DIFFS[selectedDiff].energyDaily;

  // Faim naturelle
  if(s.actionCount%2===0) s.hunger += DIFFS[selectedDiff].hungerTick;

  // Bornes
  s.money = Math.max(0, s.money);
  s.energy = clamp(s.energy,0,100);
  s.hunger = clamp(s.hunger,0,100);
  s.patience = clamp(s.patience,0,100);
  s.yamy = clamp(s.yamy,0,100);

  // Trackers
  if((evt.title.includes('Marche')||evt.title.includes('pied')) && ch.text.includes('Marcher')){
    game.walkCount++; if(game.walkCount>=5 && !game.achievements.includes('walker')){ game.achievements.push('walker'); showNote('ğŸš¶â€â™€ï¸','Achievement: Marcheuse'); sounds.achievement(); }
  }
  if((evt.title.includes('MÃ©tro')||evt.category==='transport') && ch.text.includes('MÃ©tro')){
    game.metroCount++; if(game.metroCount>=10 && !game.achievements.includes('metro_master')){ game.achievements.push('metro_master'); showNote('ğŸš‡','Achievement: Metro Master'); sounds.achievement(); }
  }

  // Achievement direct attachÃ© au choix
  if(ch.achievement && !game.achievements.includes(ch.achievement)){
    game.achievements.push(ch.achievement);
    const a = achievementsList.find(x=>x.id===ch.achievement);
    if(a){ showNote(a.icon,`Achievement: ${a.title}`); sounds.achievement(); }
  }

  s.actionCount++;
  s.statsHistory.push({ action:s.actionCount, money:s.money, energy:s.energy, hunger:s.hunger, patience:s.patience, yamy:s.yamy });

  addJournal(evt.title, evt.category);
  renderState();

  if(checkGameOver()) return;

  // Changement de jour
  if(s.actionCount % DAY_ACTIONS === 0){
    s.day++;
    if(s.day>5){ victory(); return; }
    showNote('ğŸ—“ï¸',`Jour ${s.day} â€” difficultÃ© cumulÃ©e`);
    game.daySpending=0; game.patienceStreak=0;
  }
  setTimeout(showEvent, 500);
}

/* ================== RENDER ================== */
function renderState(){
  const s=game.state;
  const turnsLeft = DAY_ACTIONS - (s.actionCount % DAY_ACTIONS || DAY_ACTIONS);
  document.getElementById('turnsLeft').textContent = turnsLeft;

  document.getElementById('day').textContent = s.day;
  document.getElementById('money').textContent = fmt(s.money);
  document.getElementById('energy').textContent = fmt(s.energy);
  document.getElementById('hunger').textContent = fmt(s.hunger);
  document.getElementById('patience').textContent = fmt(s.patience);
  document.getElementById('yamy').textContent = fmt(s.yamy);
  document.getElementById('moodIcon').textContent = moodEmoji();

  document.getElementById('moneyBar').style.width = (s.maxMoney? Math.min(100,(s.money/s.maxMoney)*100) : 100)+'%';
  document.getElementById('energyBar').style.width = s.energy+'%';
  document.getElementById('hungerBar').style.width = s.hunger+'%';
  document.getElementById('patienceBar').style.width = s.patience+'%';
  document.getElementById('yamyBar').style.width = s.yamy+'%';

  // Critiques
  const crits=[];
  if(s.money<50) crits.push('ğŸ’¸ Budget critique');
  if(s.energy<30) crits.push('ğŸ˜´ Ã‰nergie basse');
  if(s.hunger>70) crits.push('ğŸ” Faim Ã©levÃ©e');
  if(s.patience<30) crits.push('ğŸ˜¡ Patience faible');
  if(s.yamy<30) crits.push('ğŸ’” Manque de Yamy');
  document.getElementById('critBox').innerHTML = crits.length ? `<div class="row" style="color:#ffd700">${crits.join(' Â· ')}</div>` : '';

  toggleCrit('moneyLabel', s.money>=50);
  toggleCrit('energyLabel', s.energy>=30);
  toggleCrit('hungerLabel', s.hunger<=70);
  toggleCrit('patienceLabel', s.patience>=30);
  toggleCrit('yamyLabel', s.yamy>=30);
}
function toggleCrit(id, ok){
  const el=document.getElementById(id);
  if(!el) return;
  el.classList.toggle('crit', !ok);
}

/* ================== OVERLAYS & NAV ================== */
function toggleOverlay(id, forceShow){
  const ov = document.getElementById(id);
  const show = forceShow ?? !ov.classList.contains('show');
  if(show){
    ov.classList.add('show');
    if(id==='journalOverlay') updateJournalUI();
    if(id==='achievementsOverlay') updateAchievementsUI();
    if(id==='statsOverlay') updateStatsOverlay();
    // click outside to close
    ov.onclick = (e)=>{ if(e.target===ov) ov.classList.remove('show'); };
  } else ov.classList.remove('show');
}
function updateStatsOverlay(){
  const h = game.state.statsHistory.slice(-24);
  document.getElementById('statsHistory').innerHTML = `
    <div style="background:rgba(102,126,234,.08);padding:10px;border-radius:10px">
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;font-weight:800;text-align:center">
        <div>ğŸ’°</div><div>âš¡</div><div>ğŸ”</div><div>ğŸ˜¤</div><div>ğŸ’•</div>
      </div>
      ${h.map(x=>`
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;text-align:center;border-top:1px solid rgba(0,0,0,.08);padding:4px 0">
          <div>${fmt(x.money)}</div><div>${fmt(x.energy)}</div><div>${fmt(x.hunger)}</div><div>${fmt(x.patience)}</div><div>${fmt(x.yamy)}</div>
        </div>`).join('')}
    </div>`;
  const total = Object.values(game.spending).reduce((a,b)=>a+b,0);
  const cat = {food:'ğŸ” Nourriture',transport:'ğŸš‡ Transport',culture:'ğŸ¨ Culture',shopping:'ğŸ›ï¸ Shopping',other:'ğŸ“¦ Autre'};
  document.getElementById('spendingBreakdown').innerHTML = `
    <div style="background:rgba(102,126,234,.08);padding:10px;border-radius:10px">
    ${Object.entries(game.spending).map(([k,v])=>{
      const p = total? Math.round(v/total*100):0;
      return `<div style="margin:6px 0">
        <div class="row"><span>${cat[k]}</span><span><b>${fmt(v)}</b> (${p}%)</span></div>
        <div style="height:10px;background:rgba(0,0,0,.15);border-radius:8px;overflow:hidden"><div style="height:100%;width:${p}%;background:#667eea"></div></div>
      </div>`;
    }).join('')}
    <div style="text-align:center;margin-top:8px;font-weight:800">Total: ${fmt(total)}$</div>
    </div>`;
  document.getElementById('generalStats').innerHTML = `
    <div style="background:rgba(102,126,234,.08);padding:12px;border-radius:10px;text-align:center"><div style="font-size:1.3em;font-weight:800;color:#667eea">${game.state.actionCount}</div><div>Actions</div></div>
    <div style="background:rgba(102,126,234,.08);padding:12px;border-radius:10px;text-align:center"><div style="font-size:1.3em;font-weight:800;color:#667eea">${game.state.photos}</div><div>Photos</div></div>
    <div style="background:rgba(102,126,234,.08);padding:12px;border-radius:10px;text-align:center"><div style="font-size:1.3em;font-weight:800;color:#667eea">${game.journal.length}</div><div>Journal</div></div>
    <div style="background:rgba(102,126,234,.08);padding:12px;border-radius:10px;text-align:center"><div style="font-size:1.3em;font-weight:800;color:#667eea">${game.achievements.length}/25</div><div>Achievements</div></div>`;
}

/* ================== GAME LIFECYCLE ================== */
function startGame(){
  sounds.click();
  // init difficulty
  document.getElementById('diffLabel').textContent = DIFFS[selectedDiff].label;

  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  document.getElementById('bottomNav').classList.remove('hidden');

  Object.assign(game.state, { day:1, actionCount:0, money:300, energy:100, hunger:40, patience:100, yamy:100, photos:0, maxMoney:300, combo:0, lastChoiceType:null, statsHistory:[] });
  game.journal=[]; game.achievements=[]; game.usedEvents=[]; game.currentFilter='all';
  game.spending={ food:0, transport:0, culture:0, shopping:0, other:0 };
  game.energyStreak=0; game.patienceStreak=0; game.daySpending=0; game.miniGamesWon=0; game.walkCount=0; game.metroCount=0; game.kevinAvoidCount=0;

  renderState(); updateAchievementsUI(); showEvent();
  showNote('ğŸ—½','Bienvenue Ã  NYCâ€¦ bonne chance !');
}

function restartGame(){
  document.getElementById('gameOverScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  document.getElementById('bottomNav').classList.remove('hidden');
  ['journalOverlay','achievementsOverlay','statsOverlay'].forEach(id=>document.getElementById(id).classList.remove('show'));
  startGame();
}

function checkGameOver(){
  const s=game.state;
  let r='';
  if(s.money<=0) r="ğŸ’¸ FauchÃ©e â€” impossible de continuer.";
  else if(s.energy<=0) r="ğŸ˜´ EffondrÃ©e de fatigue.";
  else if(s.hunger>=100) r="ğŸ” Malaise de faim.";
  else if(s.patience<=0) r="ğŸ˜¡ A explosÃ©â€¦ (social KO).";
  else if(s.yamy<=0) r="ğŸ’” Le manque de Yamy est trop fort.";
  if(r){ endGame(r); return true; }
  return false;
}
function endGame(reason){
  document.getElementById('gameScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.remove('hidden');
  document.getElementById('bottomNav').classList.add('hidden');
  document.getElementById('gameOverReason').textContent = reason;

  document.getElementById('finalDays').textContent=game.state.day;
  document.getElementById('finalActions').textContent=game.state.actionCount;
  document.getElementById('finalMoney').textContent=fmt(game.state.money);
  document.getElementById('finalPhotos').textContent=game.state.photos;
  document.getElementById('finalAchievements').textContent=game.achievements.length;

  checkAchievements();
}
function victory(){
  checkAchievements();
  endGame(`ğŸ‰ VICTOIRE ! 5 jours Ã  NYC â€” ${game.state.photos} photos et des souvenirsâ€¦`);
}

/* ================== WIRING ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // difficulty select
  document.querySelectorAll('#diffSelect .pill').forEach(btn=>{
    if(btn.dataset.diff===selectedDiff) btn.classList.add('active');
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#diffSelect .pill').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      selectedDiff = btn.dataset.diff;
      localStorage.setItem('msnyc_diff', selectedDiff);
    });
  });

  document.getElementById('startBtn').addEventListener('click', startGame);
  document.getElementById('restartBtn').addEventListener('click', restartGame);

  // bottom nav
  document.getElementById('journalBtn').addEventListener('click', ()=>toggleOverlay('journalOverlay'));
  document.getElementById('achievementsBtn').addEventListener('click', ()=>toggleOverlay('achievementsOverlay'));
  document.getElementById('statsBtn').addEventListener('click', ()=>toggleOverlay('statsOverlay'));
  document.getElementById('soundBtn').addEventListener('click', ()=>{
    soundEnabled = !soundEnabled;
    localStorage.setItem('msnyc_sound', JSON.stringify(soundEnabled));
    document.getElementById('soundBtn').textContent = soundEnabled? 'ğŸ”Š':'ğŸ”‡';
    if(soundEnabled) sounds.success();
  });
  document.getElementById('soundBtn').textContent = soundEnabled? 'ğŸ”Š':'ğŸ”‡';

  // overlay close buttons
  document.querySelectorAll('.overlay [data-close]').forEach(b=>b.addEventListener('click', (e)=> e.currentTarget.closest('.overlay').classList.remove('show')));

  // filters
  document.getElementById('filters').addEventListener('click', (e)=>{
    const btn = e.target.closest('.filter-btn'); if(!btn) return;
    document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active'); game.currentFilter = btn.dataset.filter; updateJournalUI();
  });
});
</script>
</body>
</html>
