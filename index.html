<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Maiko Survival NYC üóΩ</title>
<link rel="icon" href="data:,">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  :root{
    --glass: rgba(255,255,255,.15);
    --glass-2: rgba(255,255,255,.22);
    --ink:#fff; --ink-dark:#333;
    --brand1:#667eea; --brand2:#764ba2;
    --warn:#ff6b6b; --ok:#22c55e; --gold:#ffd700;
  }
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,system-ui,sans-serif;background:linear-gradient(135deg,var(--brand1),var(--brand2));min-height:100vh;color:var(--ink);overflow-x:hidden;touch-action:pan-y}
  .game-container{max-width:540px;margin:0 auto;padding:16px 16px 88px}
  .header{text-align:center;padding:16px 10px;animation:fadeIn .5s ease-in}
  .header h1{font-size:1.9em;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
  .sub{opacity:.85}
  .mood-indicator{font-size:2.2em;margin:8px 0}
  .row{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .stats-container{background:var(--glass);backdrop-filter:blur(10px);border-radius:16px;padding:14px;margin:12px 0;border:1px solid rgba(255,255,255,.2)}
  .stat{margin-bottom:10px}
  .stat:last-child{margin-bottom:0}
  .stat-label{display:flex;justify-content:space-between;font-weight:600;font-size:.95em;margin-bottom:6px}
  .stat-label.crit{color:var(--gold);text-shadow:0 0 8px rgba(255,215,0,.6)}
  .stat-bar{width:100%;height:16px;background:rgba(0,0,0,.28);border-radius:10px;overflow:hidden}
  .stat-fill{height:100%;border-radius:10px;transition:width .35s ease}
  .money-fill{background:linear-gradient(90deg,#ffd700,#ffed4e)}
  .energy-fill{background:linear-gradient(90deg,#4ecdc4,#44a8a0)}
  .hunger-fill{background:linear-gradient(90deg,#ff6b6b,#ee5a52)}
  .patience-fill{background:linear-gradient(90deg,#a8e6cf,#7bc9a0)}
  .yamy-fill{background:linear-gradient(90deg,#ff69b4,#ff1493)}
  .topline{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 0}
  .turns{font-size:.9em;opacity:.9}
  .turns b{font-size:1.05em}
  .day-counter{text-align:center;font-size:1.35em;font-weight:700;margin:6px 0}
  .event-card{background:rgba(255,255,255,.2);backdrop-filter:blur(8px);border-radius:16px;padding:16px;border:2px solid rgba(255,255,255,.28);box-shadow:0 8px 28px rgba(0,0,0,.1);margin-top:10px}
  .event-rare{border-color:#ffd700;box-shadow:0 0 0 2px rgba(255,215,0,.3)}
  .event-emoji{font-size:2.2em;text-align:center;margin-bottom:8px}
  .event-title{text-align:center;font-weight:800;margin-bottom:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;font-size:.8em;background:rgba(0,0,0,.25);padding:4px 8px;border-radius:999px;margin:6px auto 10px}
  .event-description{text-align:center;opacity:.95;margin-bottom:12px}
  .choices{display:flex;flex-direction:column;gap:10px}
  .choice-btn{position:relative;background:rgba(255,255,255,.16);border:2px solid rgba(255,255,255,.35);border-radius:14px;padding:12px 14px;text-align:left;color:#fff;font-weight:650;cursor:pointer}
  .choice-btn[disabled]{opacity:.6;cursor:not-allowed}
  .choice-line{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .effects{font-size:.85em;opacity:.9;margin-top:4px;line-height:1.25}
  .mini{font-size:.85em;opacity:.9}
  .start-screen,.game-over{text-align:center}
  .start-box{background:var(--glass);backdrop-filter:blur(10px);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,.2);margin-top:12px}
  .select{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .pill{padding:8px 12px;border-radius:999px;border:2px solid #ffd700;background:rgba(255,215,0,.18);cursor:pointer;font-weight:700}
  .pill.active{background:#ffd700;color:#333}
  .start-btn,.restart-btn{margin-top:14px;background:linear-gradient(135deg,#ffd700,#ff6b6b);border:none;border-radius:22px;padding:12px 28px;font-size:1.05em;color:#fff;font-weight:800;cursor:pointer}
  .bottom-nav{position:fixed;inset:auto 0 0 0;background:rgba(0,0,0,.82);backdrop-filter:blur(10px);padding:10px;display:flex;justify-content:space-around;z-index:1000}
  .nav-btn{background:rgba(255,255,255,.14);border:2px solid rgba(255,255,255,.35);border-radius:12px;padding:10px 14px;font-size:1.05em;color:#fff;cursor:pointer;position:relative}
  .badge-count{position:absolute;top:-7px;right:-7px;background:#ff6b6b;color:#fff;border-radius:999px;width:22px;height:22px;font-size:.7em;display:flex;align-items:center;justify-content:center;border:2px solid #fff;font-weight:800}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.86);z-index:1500;display:none}
  .overlay.show{display:block;animation:fadeIn .2s}
  .overlay .panel{max-width:540px;margin:18px auto;background:#fff;color:#333;border-radius:16px;padding:22px;position:relative}
  .close-btn{position:absolute;top:10px;right:10px;background:#ff6b6b;border:none;color:#fff;border-radius:999px;width:36px;height:36px;font-size:1.1em;cursor:pointer}
  .journal-filters{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0}
  .filter-btn{border:2px solid #667eea;background:rgba(102,126,234,.08);color:#667eea;padding:6px 10px;border-radius:999px;cursor:pointer}
  .filter-btn.active{background:#667eea;color:#fff}
  .journal-entry{background:rgba(102,126,234,.06);border-left:4px solid #667eea;padding:12px;border-radius:10px;margin-bottom:10px}
  .notification{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:rgba(255,215,0,.96);color:#333;border:2px solid #ffd700;border-radius:14px;padding:10px 14px;z-index:2000;animation:slideDown .25s ease}
  .combo-indicator{position:fixed;top:90px;right:16px;background:rgba(255,107,107,.92);border:2px solid #ff6b6b;color:#fff;border-radius:12px;padding:8px 10px;font-weight:800;z-index:1200}
  .tooltip{font-size:.85em;opacity:.85;margin-top:4px;text-align:right}
  .crit-msg{margin-top:8px;font-size:.9em}
  @media (prefers-reduced-motion: reduce){
    *{animation:none !important;transition:none !important}
  }
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
</style>
</head>
<body>
<div class="game-container">
  <!-- START -->
  <div id="startScreen" class="start-screen">
    <div class="header">
      <div style="font-size:3.2em;margin-bottom:10px">üóΩ</div>
      <h1>MAIKO SURVIVAL NYC</h1>
      <div class="sub">Version √©quilibr√©e & difficile</div>
    </div>
    <div class="start-box">
      <div><strong>Choisis la difficult√©</strong></div>
      <div class="select" id="diffSelect">
        <button class="pill" data-diff="easy">Facile</button>
        <button class="pill active" data-diff="normal">Normal</button>
        <button class="pill" data-diff="hard">Difficile</button>
      </div>
      <div style="margin-top:8px;font-size:.95em;opacity:.9">
        <div>‚Ä¢ Prix & taxes r√©elles ¬∑ faim naturelle ¬∑ fatigue progressive</div>
        <div>‚Ä¢ Rares moins ‚ÄúOP‚Äù, punition des mauvais encha√Ænements</div>
      </div>
      <button class="start-btn" id="startBtn">üöÄ D√©marrer</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="gameScreen" class="hidden">
    <div class="header">
      <h1>üóΩ MAIKO √Ä NYC</h1>
      <div class="sub">Difficult√©: <span id="diffLabel">Normal</span></div>
      <div class="mood-indicator" id="moodIcon">üòä</div>
    </div>
    <div class="row topline">
      <div class="day-counter">Jour <b id="day">1</b>/5</div>
      <div class="turns">Actions restantes: <b id="turnsLeft">8</b>/8</div>
    </div>

    <div class="stats-container">
      <div class="stat">
        <div class="stat-label" id="moneyLabel"><span>üí∞ Argent</span><span><b id="money">300</b>$</span></div>
        <div class="stat-bar"><div class="stat-fill money-fill" id="moneyBar" style="width:100%"></div></div>
      </div>
      <div class="stat">
        <div class="stat-label" id="energyLabel"><span>‚ö° √ânergie</span><span><b id="energy">100</b>%</span></div>
        <div class="stat-bar"><div class="stat-fill energy-fill" id="energyBar" style="width:100%"></div></div>
      </div>
      <div class="stat">
        <div class="stat-label" id="hungerLabel"><span>üçî Faim</span><span><b id="hunger">40</b>%</span></div>
        <div class="stat-bar"><div class="stat-fill hunger-fill" id="hungerBar" style="width:40%"></div></div>
      </div>
      <div class="stat">
        <div class="stat-label" id="patienceLabel"><span>üò§ Patience</span><span><b id="patience">100</b>%</span></div>
        <div class="stat-bar"><div class="stat-fill patience-fill" id="patienceBar" style="width:100%"></div></div>
      </div>
      <div class="stat">
        <div class="stat-label" id="yamyLabel"><span>üíï Yamy</span><span><b id="yamy">100</b>%</span></div>
        <div class="stat-bar"><div class="stat-fill yamy-fill" id="yamyBar" style="width:100%"></div></div>
      </div>
      <div id="critBox" class="crit-msg"></div>
    </div>

    <div id="eventContainer"></div>
  </div>

  <!-- GAME OVER -->
  <div id="gameOverScreen" class="hidden game-over">
    <h2>üíÄ GAME OVER üíÄ</h2>
    <div id="gameOverReason" style="margin:10px 0 6px"></div>
    <div class="start-box" style="color:#333">
      <div><b>Jours:</b> <span id="finalDays">0</span></div>
      <div><b>Actions:</b> <span id="finalActions">0</span></div>
      <div><b>Argent:</b> $<span id="finalMoney">0</span></div>
      <div><b>Photos:</b> <span id="finalPhotos">0</span></div>
      <div><b>Achievements:</b> <span id="finalAchievements">0</span>/25</div>
    </div>
    <button class="restart-btn" id="restartBtn">üîÑ Recommencer</button>
  </div>

  <!-- NAV -->
  <div id="bottomNav" class="bottom-nav hidden">
    <button class="nav-btn" id="journalBtn" title="J">üìî<span class="badge-count" id="journalBadge">0</span></button>
    <button class="nav-btn" id="achievementsBtn" title="A">üèÜ<span class="badge-count" id="achievementsBadge">0</span></button>
    <button class="nav-btn" id="statsBtn" title="S">üìä</button>
    <button class="nav-btn" id="soundBtn" title="Son">üîá</button>
  </div>
</div>

<!-- Overlays -->
<div id="journalOverlay" class="overlay"><div class="panel">
  <button class="close-btn" data-close>√ó</button>
  <h2 style="color:#667eea;text-align:center">üìî Journal</h2>
  <div class="journal-filters" id="filters">
    <button class="filter-btn active" data-filter="all">Tout</button>
    <button class="filter-btn" data-filter="yamy">üíï Yamy</button>
    <button class="filter-btn" data-filter="food">üçî Bouffe</button>
    <button class="filter-btn" data-filter="photos">üì∏ Photos</button>
    <button class="filter-btn" data-filter="mood">üò§ Mood</button>
  </div>
  <div id="journalStats" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:8px;font-size:.95em"></div>
  <div id="journalEntries"></div>
</div></div>

<div id="achievementsOverlay" class="overlay"><div class="panel">
  <button class="close-btn" data-close>√ó</button>
  <h2 style="color:#667eea;text-align:center">üèÜ Achievements</h2>
  <div id="achievementsList"></div>
</div></div>

<div id="statsOverlay" class="overlay"><div class="panel">
  <button class="close-btn" data-close>√ó</button>
  <h2 style="color:#667eea;text-align:center">üìä Statistiques</h2>
  <div id="statsHistory"></div>
  <div id="spendingBreakdown" style="margin-top:12px"></div>
  <div id="generalStats" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px"></div>
</div></div>

<div id="notificationContainer"></div>
<div id="comboIndicator" class="combo-indicator hidden">
  üî• COMBO <span id="comboX">x1</span>
  <div class="tooltip">Bonus positifs +5% par niveau</div>
</div>

<script>
/* ================== SETTINGS & UTILS ================== */
const TAX = 0.08875; // NYC sales tax approx
const TIP_MIN = 0.10, TIP_MAX = 0.20; // typical tips on food
const DAY_ACTIONS = 8;

const DIFFS = {
  easy:   { label:'Facile',  price:0.95, hungerTick:5, energyDaily:0, yamyWear:2, rareBuff:1.0 },
  normal: { label:'Normal',  price:1.00, hungerTick:7, energyDaily:2, yamyWear:3, rareBuff:1.0 },
  hard:   { label:'Difficile', price:1.15, hungerTick:10, energyDaily:4, yamyWear:5, rareBuff:1.15 }
};

let soundEnabled = JSON.parse(localStorage.getItem('msnyc_sound')||'false');
let selectedDiff = localStorage.getItem('msnyc_diff') || 'normal';

function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
function vibrate(ms=50){ if('vibrate' in navigator) navigator.vibrate(ms); }
function fmt(n){ return Math.round(n); }
function showNote(icon, text){
  const n = document.createElement('div');
  n.className='notification'; n.innerHTML=`<b style="margin-right:6px">${icon}</b>${text}`;
  document.getElementById('notificationContainer').appendChild(n);
  setTimeout(()=>n.remove(), 2500);
}

/* ================== AUDIO ================== */
const sounds = {
  click: () => play(500, .08, .05),
  success: () => play(820, .12, .09),
  fail: () => play(220, .14, .1),
  achievement: () => { play(600,.08,.06); setTimeout(()=>play(820,.08,.06),100); setTimeout(()=>play(1000,.12,.08),220); }
};
function play(freq, duration, volume){
  if(!soundEnabled) return;
  try{
    const Ctx = window.AudioContext||window.webkitAudioContext;
    if(!Ctx) return;
    const ctx = new Ctx(), osc=ctx.createOscillator(), g=ctx.createGain();
    osc.connect(g); g.connect(ctx.destination);
    osc.frequency.value=freq; g.gain.value=volume;
    osc.start(); osc.stop(ctx.currentTime+duration);
  }catch(e){}
}

/* ================== STATE ================== */
const game = {
  state: { day:1, actionCount:0, money:300, energy:100, hunger:40, patience:100, yamy:100, photos:0, maxMoney:300, combo:0, lastChoiceType:null, statsHistory:[] },
  journal: [], achievements: [], usedEvents: [], availableEvents: [], currentFilter:'all',
  spending: { food:0, transport:0, culture:0, shopping:0, other:0 },
  energyStreak:0, patienceStreak:0, daySpending:0, miniGamesWon:0, walkCount:0, metroCount:0, kevinAvoidCount:0
};

/* ================== DATA (quotes / achievements / events) ================== */
const quotes = {
  hungry:["Je vais croquer un taxi l√†","Mon ventre crie au secours","J‚Äôai des √©toiles devant les yeux","Tout est nourriture autour de moi"],
  tired:["Mes jambes sont en carton","Sieste sur un trottoir ok?","J‚Äôai clign√© trop longtemps -> dodo","Je marche en pilote auto"],
  broke:["NYC m‚Äôa rackett√©e","Je vais vendre mes chaussures","Budget √©vapor√©","Note √† moi-m√™me: plus jamais"],
  impatient:["Ne me parlez pas merci","Je deviens allergique aux gens","Profs = boss de fin","Je boude activement"],
  happy:["Ok c‚Äôest styl√© de ouf","C‚Äôest exactement comme dans les films","Je kiffe cette journ√©e","Le mood est au vert"],
  photos:["Mon stockage pleure","Encore une, juste une‚Ä¶","La lumi√®re est insane","Je suis la paparazzi de moi-m√™me"],
  food:["Tout est XXL ici","Beurre + sucre + friture = üá∫üá∏","Rien ne bat un bon ramen","Je r√™ve de l√©gumes"],
  nyc:["NYC est une machine √† fatigue","Bruyant, grand, vivant","Je comprends le mythe","Clermont me manque un peu"],
  group:["Le groupe tra√Æne les pieds","On s‚Äôest quand m√™me marr√©s","Tout le monde r√¢le en ch≈ìur","Photo de groupe rat√©e x12"],
  yamy:["Yamy me manque","Spamm√© de c≈ìurs (pardon)","Une peluche pour Yamy?","Je veux lui raconter tout"],
  missYamy:["Le manque commence √† piquer","Je veux juste un c√¢lin l√†","Le d√©calage me nargue","Reviens vite pls"]
};

const achievementsList = [
  {id:'first_day', icon:'üóìÔ∏è', title:'Premier Jour', desc:'Survivre au jour 1', condition:()=>game.state.day>=2},
  {id:'survivor', icon:'üèÜ', title:'Survivor', desc:'Terminer le voyage', condition:()=>game.state.day>5},
  {id:'broke', icon:'üí∏', title:'Fauch√©e', desc:'Avoir moins de 50$', condition:()=>game.state.money<50},
  {id:'rich', icon:'üí∞', title:'√âconome', desc:'Finir avec plus de 200$', condition:()=>game.state.day>5 && game.state.money>200},
  {id:'photographer', icon:'üì∏', title:'Photographe', desc:'Prendre 50 photos', condition:()=>game.state.photos>=50},
  {id:'paparazzi', icon:'üì∑', title:'Paparazzi', desc:'Prendre 100 photos', condition:()=>game.state.photos>=100},
  {id:'foodie', icon:'üçî', title:'Foodie', desc:'Manger 10 fois', condition:()=>game.journal.filter(e=>e.category==='food').length>=10},
  {id:'starving', icon:'üòµ', title:'Affam√©e', desc:'Avoir 90%+ de faim', condition:()=>game.state.hunger>=90},
  {id:'energizer', icon:'‚ö°', title:'√ânergique', desc:'80%+ √©nergie 5 actions', condition:()=>false},
  {id:'zen', icon:'üßò', title:'Zen Master', desc:'90%+ patience un jour', condition:()=>false},
  {id:'love_birds', icon:'üíï', title:'Love Birds', desc:'Yamy 90%+ longtemps', condition:()=>game.state.yamy>=90 && game.state.actionCount>10},
  {id:'heartbroken', icon:'üíî', title:'Heartbroken', desc:'Yamy ‚â§ 20%', condition:()=>game.state.yamy<=20},
  {id:'labubu', icon:'üß∏', title:'Best GF', desc:'Acheter le Labubu', condition:()=>false},
  {id:'spender', icon:'üí≥', title:'D√©pensi√®re', desc:'300$ en un jour', condition:()=>false},
  {id:'walker', icon:'üö∂‚Äç‚ôÄÔ∏è', title:'Marcheuse', desc:'Refuser 5 transports', condition:()=>false},
  {id:'metro_master', icon:'üöá', title:'Metro Master', desc:'10 m√©tros', condition:()=>false},
  {id:'tourist', icon:'üóΩ', title:'Touriste Ultime', desc:'Spots iconiques', condition:()=>false},
  {id:'combo_master', icon:'üî•', title:'Combo Master', desc:'Combo x5', condition:()=>false},
  {id:'lucky', icon:'üçÄ', title:'Chanceuse', desc:'√âv√®nement rare', condition:()=>false},
  {id:'minigame_master', icon:'üéÆ', title:'Mini-jeu Pro', desc:'3 mini-jeux', condition:()=>false},
  {id:'photo_perfectionist', icon:'üì∏', title:'Perfectionniste Photo', desc:'Photo parfaite', condition:()=>false},
  {id:'negotiator', icon:'üí∞', title:'N√©gociatrice', desc:'N√©gociation ok', condition:()=>false},
  {id:'journal_writer', icon:'üìî', title:'√âcrivaine', desc:'30 entr√©es', condition:()=>game.journal.length>=30},
  {id:'balanced', icon:'‚öñÔ∏è', title:'√âquilibr√©e', desc:'Stats >50% en fin', condition:()=>game.state.day>5 && game.state.money>100 && game.state.energy>50 && game.state.hunger<50 && game.state.patience>50 && game.state.yamy>50},
  {id:'perfectionist', icon:'üíé', title:'Perfectionniste', desc:'Stats >70% en fin', condition:()=>game.state.day>5 && game.state.energy>70 && game.state.hunger<30 && game.state.patience>70 && game.state.yamy>70}
];

const baseEvents = [
  {emoji:"üçï",title:"Pizzeria",desc:"Pizzeria ch√®re. Maiko a FAIM.",category:'food',
   choices:[{text:"üçï Part (8$)",cost:8,effects:{hunger:-25,energy:+4}},{text:"üö´ Refuser",effects:{hunger:+8,patience:-10}}]},
  {emoji:"‚òï",title:"Starbucks",desc:"Caf√© pour tenir.",category:'food',
   choices:[{text:"‚òï Latte (6.5$)",cost:6.5,effects:{energy:+14,patience:+6}},{text:"üíß Eau",effects:{energy:+3,patience:-6}}]},
  {emoji:"üö∂‚Äç‚ôÄÔ∏è",title:"Marche 2h",desc:"Le prof veut marcher longtemps.",category:'transport',
   choices:[{text:"üöá M√©tro (3$)",cost:3,effects:{energy:+6,patience:-6}},{text:"üëü Marcher",effects:{energy:-18,patience:-10}}]},
  {emoji:"ü•¢",title:"Resto Asiat",desc:"ENFIN de la vraie bouffe.",category:'food',
   choices:[{text:"üçú Bol (15$)",cost:15,effects:{hunger:-32,patience:+14,energy:+6}},{text:"üçî Fast-food",effects:{hunger:-10,patience:-10}}]},
  {emoji:"üì∏",title:"Spot Instagram",desc:"Endroit parfait.",category:'photos',
   choices:[{text:"üì± 50 photos",effects:{energy:-10,patience:+6,photos:+8}},{text:"‚è≠Ô∏è Skip",effects:{patience:-10}}]},
  {emoji:"üò§",title:"Kevin Relou",desc:"Kevin la saoule.",category:'mood',
   choices:[{text:"üéÆ Changer de groupe",effects:{patience:+10,energy:-4}},{text:"üò° Le remettre",effects:{patience:-10,energy:-10}}]},
  {emoji:"üßã",title:"Bubble Tea",desc:"Envie de sucre.",category:'food',
   choices:[{text:"üßã Boisson (6$)",cost:6,effects:{patience:+10,hunger:-5}},{text:"üö´ Passer",effects:{patience:-10}}]},
  {emoji:"üåÜ",title:"Times Square Nuit",desc:"Illumin√© !",category:'photos',
   choices:[{text:"üì∏ 1h photos",effects:{energy:-16,patience:-6,photos:+18},achievement:'paparazzi'},{text:"üèÉ‚Äç‚ôÄÔ∏è Vite",effects:{energy:-3,patience:-10,photos:+4}}]},
  // Yamy
  {emoji:"üß∏",title:"Labubu Shop",desc:"Peluche pour Yamy ?",category:'yamy',
   choices:[{text:"üíù Acheter (35$)",cost:35,effects:{patience:+14,energy:+6,yamy:+26},achievement:'labubu'},{text:"üí∏ Trop cher",effects:{patience:-12,yamy:-10}}]},
  {emoji:"ü•®",title:"Stand de Pretzels",desc:"Odeur de pretzels chauds.",category:"food",
    choices:[{text:"ü•® Pretzel (4$)",cost:4,effects:{hunger:-10,patience:+4}},
             {text:"üö´ Passer",effects:{patience:-4}}]},
  {emoji:"üç©",title:"Doughnut Shop",desc:"Vitrine qui brille.",category:"food",
    choices:[{text:"üç© Donut (3.5$)",cost:3.5,effects:{hunger:-8,energy:+4}},
             {text:"‚òï + Donut (7$)",cost:7,effects:{hunger:-10,energy:+10}}]},
  {emoji:"üçú",title:"Food Court",desc:"Trop de choix.",category:"food",
    choices:[{text:"üçõ Plat (12$)",cost:12,effects:{hunger:-24,patience:+6}},
             {text:"ü•ó Salade (10$)",cost:10,effects:{hunger:-18,energy:+4}}]},
  {emoji:"üçï",title:"Dollar Slice Line",desc:"Queue pour la pizza √† 1$.",category:"food",
    choices:[{text:"‚è≥ Attendre (1$)",cost:1,effects:{hunger:-10,patience:-6}},
             {text:"üí∏ Pizzeria voisine (9$)",cost:9,effects:{hunger:-18,patience:+6}}]},
  {emoji:"üç£",title:"Sushis rapides",desc:"Bar √† sushis sur place.",category:"food",
    choices:[{text:"üç£ 6 pi√®ces (14$)",cost:14,effects:{hunger:-22,energy:+4}},
             {text:"üö´ Trop cher",effects:{patience:-6}}]},
  {emoji:"üåØ",title:"Food Truck Mexicain",desc:"Tacos qui sentent bon.",category:"food",
    choices:[{text:"üåÆ 2 tacos (9$)",cost:9,effects:{hunger:-16,patience:+4}},
             {text:"üåØ Burrito (12$)",cost:12,effects:{hunger:-24,energy:+4}}]},
  {emoji:"ü•§",title:"Bodega drink",desc:"Boisson fra√Æche au coin.",category:"food",
    choices:[{text:"ü•§ Soda (2.5$)",cost:2.5,effects:{energy:+4}},
             {text:"üö∞ Eau du robinet",effects:{patience:-4}}]},
  {emoji:"üßÉ",title:"Jus frais",desc:"Jus press√© minute.",category:"food",
    choices:[{text:"üçä Jus (6$)",cost:6,effects:{energy:+8,patience:+4}},
             {text:"üö´ Non merci",effects:{patience:-4}}]},
  {emoji:"üçü",title:"Frites croustillantes",desc:"Frites dor√©es, sel gant.",category:"food",
    choices:[{text:"üçü Petite (5$)",cost:5,effects:{hunger:-10}},
             {text:"üçü Grande (7$)",cost:7,effects:{hunger:-16,patience:+4}}]},
  {emoji:"üçî",title:"Diner r√©tro",desc:"Si√®ges rouges, jukebox.",category:"food",
    choices:[{text:"üçî Menu (13$)",cost:13,effects:{hunger:-26,patience:+6}},
             {text:"üç≥ ≈íufs & bacon (11$)",cost:11,effects:{hunger:-18,energy:+6}}]},

  {emoji:"üöá",title:"Changement rat√©",desc:"Tu as pris la mauvaise direction.",category:"transport",
    choices:[{text:"üß≠ Recalculer (3$)",cost:3,effects:{patience:-4}},
             {text:"üëü Marcher 25 min",effects:{energy:-10,patience:-6}}]},
  {emoji:"üöå",title:"Bus MTA bond√©",desc:"Quasi pas de place assise.",category:"transport",
    choices:[{text:"üöå Serrer les coudes (2.9$)",cost:2.9,effects:{energy:+2,patience:-8}},
             {text:"üöï Prendre taxi (18$)",cost:18,effects:{energy:+10,patience:+8,photos:+2}}]},
  {emoji:"üõ¥",title:"Trottinette partag√©e",desc:"Rapide mais stressant.",category:"transport",
    choices:[{text:"üõ¥ Louer (6$)",cost:6,effects:{energy:+6,patience:-4}},
             {text:"üö∂‚Äç‚ôÄÔ∏è √Ä pied",effects:{energy:-12}}]},
  {emoji:"‚õ¥Ô∏è",title:"Staten Island Ferry",desc:"Vue gratuite sur la baie.",category:"transport",
    choices:[{text:"‚õ¥Ô∏è Embarquer (0$)",effects:{energy:-2,patience:+6,photos:+4}},
             {text:"üö´ Pas le temps",effects:{patience:-6}}]},
  {emoji:"üö¶",title:"Feu rouge interminable",desc:"Tu attends, attends‚Ä¶",category:"transport",
    choices:[{text:"üö∂‚Äç‚ôÄÔ∏è Traverser plus loin",effects:{energy:-6,patience:-4}},
             {text:"üßç Attendre",effects:{patience:-6}}]},

  {emoji:"üéüÔ∏è",title:"Billet mus√©e",desc:"Entr√©e standard ou √©tudiante ?.",category:"culture",
    choices:[{text:"üéüÔ∏è √âtudiant (12$)",cost:12,effects:{patience:+8,energy:-6,photos:+4}},
             {text:"üö´ Passer",effects:{patience:-6}}]},
  {emoji:"üñºÔ∏è",title:"Galerie de SoHo",desc:"Expo √©ph√©m√®re.",category:"culture",
    choices:[{text:"üé® Entrer (8$)",cost:8,effects:{patience:+8,photos:+3}},
             {text:"üì∑ Vitre seulement",effects:{photos:+1}}]},
  {emoji:"üé≠",title:"Impro de rue",desc:"Spectacle dr√¥le.",category:"culture",
    choices:[{text:"üíµ Tip (2$)",cost:2,effects:{patience:+6}},
             {text:"üëè Applaudir",effects:{patience:+2}}]},
  {emoji:"üìö",title:"Librairie culte",desc:"Odeur de papier.",category:"culture",
    choices:[{text:"üìñ Carnet (9$)",cost:9,effects:{patience:+6,photos:+1}},
             {text:"üëÄ Fl√¢ner",effects:{patience:+2}}]},
  {emoji:"üé∂",title:"Concert de rue",desc:"Jazz √† Bryant Park.",category:"culture",
    choices:[{text:"üé∂ Rester 20 min",effects:{energy:-4,patience:+8,photos:+2}},
             {text:"üö∂‚Äç‚ôÄÔ∏è Continuer",effects:{patience:-4}}]},

  {emoji:"üòµ‚Äçüí´",title:"Trop de bruit",desc:"Klaxons + sir√®nes = ü§Ø",category:"mood",
    choices:[{text:"üéß Musique (3$)",cost:3,effects:{patience:+8}},
             {text:"üßò Respiration",effects:{patience:+4}}]},
  {emoji:"üò†",title:"Groupe en retard",desc:"Encore 15 minutes‚Ä¶",category:"mood",
    choices:[{text:"üóìÔ∏è Replanifier",effects:{patience:+2}},
             {text:"üò§ Remontrance",effects:{patience:-8,energy:-4}}]},
  {emoji:"ü§≥",title:"Selfie fail",desc:"Yeux ferm√©s, encore.",category:"photos",
    choices:[{text:"ü§≥ Re-tenter",effects:{photos:+3,energy:-4}},
             {text:"üì∏ Demander aide",effects:{photos:+4,patience:+2}}]},
  {emoji:"üó∫Ô∏è",title:"Perdue 5 min",desc:"GPS capricieux.",category:"mood",
    choices:[{text:"üó∫Ô∏è Recalibrer",effects:{patience:-2}},
             {text:"üëÆ Demander un agent",effects:{patience:+2}}]},
  {emoji:"üßº",title:"Salle de bain introuvable",desc:"Urgence augmente.",category:"mood",
    choices:[{text:"‚òï Acheter (2.5$)",cost:2.5,effects:{patience:+6}},
             {text:"üö∂‚Äç‚ôÄÔ∏è Chercher encore",effects:{energy:-6,patience:-6}}]},

  {emoji:"üß£",title:"Souvenir bonnet NYC",desc:"Styl√© mais utile ?",category:"shopping",
    choices:[{text:"üß£ Acheter (15$)",cost:15,effects:{patience:+6,yamy:+4}},
             {text:"üí∏ Trop cher",effects:{patience:-4}}]},
  {emoji:"üëü",title:"Semelles gel",desc:"Pieds en feu.",category:"shopping",
    choices:[{text:"üëü Acheter (10$)",cost:10,effects:{energy:+10,patience:+4}},
             {text:"üí™ Tenir",effects:{energy:-6,patience:-4}}]},
  {emoji:"üß¥",title:"Cr√®me solaire",desc:"UV costauds aujourd‚Äôhui.",category:"shopping",
    choices:[{text:"üß¥ SPF (7$)",cost:7,effects:{energy:+2,patience:+2}},
             {text:"üòë Sans",effects:{energy:-4}}]},
  {emoji:"üéí",title:"Bretelles sac",desc:"Une s‚Äôest cass√©e.",category:"shopping",
    choices:[{text:"üßµ R√©parer (6$)",cost:6,effects:{energy:+4}},
             {text:"üñêÔ∏è Porter √† la main",effects:{energy:-10}}]},
  {emoji:"üì¶",title:"Casiers de gare",desc:"D√©poser des sacs.",category:"shopping",
    choices:[{text:"üîí Louer (5$)",cost:5,effects:{energy:+6}},
             {text:"üíº Garder sur soi",effects:{energy:-8}}]},
  {emoji:"üì±",title:"Appel Yamy",desc:"Un appel ? ",category:'yamy',
   choices:[{text:"üíï 20 min",effects:{energy:-6,patience:+14,yamy:+18}},{text:"‚è±Ô∏è Rapide",effects:{yamy:-10,patience:-8}}]}
];

const conditionals = [
  {emoji:"üò¥",title:"Sieste",desc:"Elle vacille‚Ä¶",category:'energy',condition:()=>game.state.energy<35,
   choices:[{text:"üí§ Dormir 1h",effects:{energy:+28,hunger:+12,yamy:-4}},{text:"‚òï Caf√© (8$)",cost:8,effects:{energy:+14}}]},
  {emoji:"üçï",title:"Pizza √† 1$",desc:"Plan radin.",category:'food',condition:()=>game.state.money<100,
   choices:[{text:"üçï Slice (1$)",cost:1,effects:{hunger:-12}},{text:"üö´ Rien",effects:{hunger:+8}}]},
   {emoji:"üåßÔ∏è",title:"Averse soudaine",desc:"Pas de parapluie.",category:"weather",
   condition:()=> game.state.energy>0 && game.state.hunger<90,
   choices:[{text:"‚òÇÔ∏è Acheter (12$)",cost:12,effects:{patience:+6}},
            {text:"üí¶ Courir",effects:{energy:-10,patience:-10}}]},
  {emoji:"üî•",title:"Trop chaud",desc:"Canicule √©crasante.",category:"weather",
   condition:()=> game.state.energy<70,
   choices:[{text:"ü•§ Boisson glac√©e (5$)",cost:5,effects:{energy:+8,patience:+4}},
            {text:"üå≥ Ombre 10 min",effects:{energy:+4}}]},
  {emoji:"üßä",title:"Clim glaciale",desc:"Dans le m√©tro.",category:"weather",
   condition:()=> game.state.energy<60,
   choices:[{text:"üß£ Acheter (8$)",cost:8,effects:{energy:+6}},
            {text:"ü•∂ Supporter",effects:{energy:-6,patience:-4}}]},
  {emoji:"üïò",title:"Retard de 30 min",desc:"Planning d√©cal√©.",category:"mood",
   condition:()=> game.state.patience<60,
   choices:[{text:"üóÇÔ∏è R√©organiser",effects:{patience:+4}},
            {text:"üòí R√¢ler",effects:{patience:-8}}]},
  {emoji:"üí§",title:"Coup de barre",desc:"Paupi√®res lourdes.",category:"energy",
   condition:()=> game.state.energy<40,
   choices:[{text:"‚òï Double shot (7$)",cost:7,effects:{energy:+16}},
            {text:"üòÆ‚Äçüí® √âtirements",effects:{energy:+6}}]},
  {emoji:"üßÉ",title:"Hypo l√©g√®re",desc:"Tu trembles un peu.",category:"food",
   condition:()=> game.state.hunger>65 && game.state.energy<50,
   choices:[{text:"üç´ Barre (3$)",cost:3,effects:{hunger:-8,energy:+8}},
            {text:"üçé Pomme (2$)",cost:2,effects:{hunger:-6}}]},
  {emoji:"üì±",title:"Batterie 10%",desc:"T√©l√©phone proche KO.",category:"other",
   condition:()=> game.state.photos>10,
   choices:[{text:"üîå Powerbank (18$)",cost:18,effects:{patience:+6}},
            {text:"üîç Spot prise",effects:{energy:-6,patience:-4}}]},
  {emoji:"üß¶",title:"Ampoule au pied",desc:"A√Øe √† chaque pas.",category:"mood",
   condition:()=> game.state.energy<70,
   choices:[{text:"üß¶ Chaussettes (6$)",cost:6,effects:{energy:+6}},
            {text:"üò£ Ignorer",effects:{energy:-8,patience:-4}}]},
  {emoji:"üß¥",title:"Mains s√®ches",desc:"Air clim‚Äô + gel hydro.",category:"other",
   condition:()=> true,
   choices:[{text:"üß¥ Cr√®me (4$)",cost:4,effects:{patience:+4}},
            {text:"ü§∑ Rien",effects:{}}]},
  {emoji:"üïê",title:"D√©calage pique",desc:"Somnolence hors horaire.",category:"energy",
   condition:()=> game.state.day<=2 && game.state.energy<60,
   choices:[{text:"üò¥ Micro-sieste 15min",effects:{energy:+10,hunger:+4,yamy:-2}},
            {text:"üö∂ Bouger",effects:{energy:+4}}]},
  {emoji:"üòÆ‚Äçüí®",title:"Stress du groupe",desc:"Trop de bruit, trop vite.",category:"mood",
   condition:()=> game.state.patience<50,
   choices:[{text:"üßò 4-7-8",effects:{patience:+8}},
            {text:"üéß Isolement",effects:{patience:+6,energy:+2}}]},
  {emoji:"üßÉ",title:"Sirop d‚Äô√©rable tentant",desc:"Boutique souvenir.",category:"shopping",
   condition:()=> game.state.money>40,
   choices:[{text:"üçÅ Petit flacon (8$)",cost:8,effects:{yamy:+4,patience:+4}},
            {text:"üö´ C‚Äôest lourd",effects:{patience:-2}}]},
  {emoji:"üß∏",title:"Peluche alternative",desc:"Kitsch mais dr√¥le.",category:"yamy",
   condition:()=> !game.achievements.includes('labubu'),
   choices:[{text:"üß∏ (20$)",cost:20,effects:{yamy:+12,patience:+4}},
            {text:"üì∑ Photo √† la place",effects:{photos:+2}}]},
  {emoji:"üìÖ",title:"Planning compress√©",desc:"Deux spots √† caser.",category:"mood",
   condition:()=> game.state.day>=3,
   choices:[{text:"üèÉ‚Äç‚ôÄÔ∏è Acc√©l√©rer",effects:{energy:-8,patience:-4}},
            {text:"‚ùå Annuler un spot",effects:{patience:+4}}]},
  {emoji:"üßº",title:"Tache sur t-shirt",desc:"Photo tout √† l‚Äôheure‚Ä¶",category:"other",
   condition:()=> game.state.photos>15,
   choices:[{text:"üëï T-shirt (12$)",cost:12,effects:{patience:+6}},
            {text:"üßª Nettoyer vite",effects:{patience:+2}}]},
  {emoji:"üí∞",title:"ATM",desc:"Besoin de cash ?",category:'money',condition:()=>game.state.money<50,
   choices:[{text:"üíµ 50$ (+5$ frais)",cost: -45, effects:{}},{text:"‚ùå Continuer",effects:{patience:-6}}]} // cost n√©gative = gain net
];

const rares = [
  {emoji:"‚≠ê",title:"C√©l√©brit√©!",desc:"Crois√©e au coin de la rue.",category:'rare',
   choices:[{text:"üì± Photo",effects:{energy:-4,patience:+18,photos:+4}},{text:"üëÄ Laisser",effects:{patience:-10}}],achievement:'lucky'},
  {emoji:"üíº",title:"Portefeuille rendu",desc:"Quelqu‚Äôun te rend un portefeuille perdu.",category:"rare",
    choices:[{text:"üíµ R√©compense",effects:{money:+40,patience:+10}},
             {text:"üôè Juste merci",effects:{patience:+12}}],achievement:"lucky"},
  {emoji:"üéüÔ∏è",title:"Entr√©es comp offertes",desc:"Tu tombes sur une disrib d‚Äôinvitations.",category:"rare",
    choices:[{text:"üé≠ Spectacle",effects:{patience:+14,photos:+4,energy:-6}},
             {text:"üé∂ Concert",effects:{patience:+12,photos:+6,energy:-8}}],achievement:"lucky"},
  {emoji:"üßæ",title:"Erreur de caisse",desc:"Le total est plus bas qu‚Äôaffich√©.",category:"rare",
    choices:[{text:"‚úÖ Payer moins",effects:{money:+10,patience:+8}},
             {text:"ü§ù Signaler",effects:{patience:+10}}],achievement:"lucky"},
  {emoji:"üì∏",title:"Ciel incroyable",desc:"Golden hour parfaite.",category:"rare",
    choices:[{text:"üì∏ Mitrailler",effects:{photos:+12,energy:-6,patience:+8}},
             {text:"üëÄ Profiter",effects:{patience:+10}}],achievement:"lucky"},
  {emoji:"üóΩ",title:"Guide super sympa",desc:"Te file 2 astuces secr√®tes.",category:"rare",
    choices:[{text:"üìç Spot secret",effects:{photos:+8,patience:+10}},
             {text:"üí∏ Bon plan -5$",effects:{money:+5,patience:+6}}],achievement:"lucky"},
  {emoji:"üéÅ",title:"Goodie bag",desc:"Samples gratuits.",category:"rare",
    choices:[{text:"üéÅ Prendre",effects:{patience:+8,energy:+4}},
             {text:"üëã Laisser",effects:{}}],achievement:"lucky"},
  {emoji:"üöï",title:"Taxi offre la course",desc:"Histoire improbable mais vrai.",category:"rare",
    choices:[{text:"üöï Monter",effects:{energy:+12,patience:+10}},
             {text:"üö∂‚Äç‚ôÄÔ∏è Refuser",effects:{}}],achievement:"lucky"},
  {emoji:"üí≥",title:"Cashback √©clair",desc:"Promo bancaire furtive.",category:"rare",
    choices:[{text:"üí≥ Activer",effects:{money:+15,patience:+6}},
             {text:"‚è≠Ô∏è Ignorer",effects:{}}],achievement:"lucky"},
  {emoji:"üì±",title:"Wifi public turbo",desc:"Upload tes stories instant.",category:"rare",
    choices:[{text:"üöÄ Spam stories",effects:{photos:+8,patience:+6,energy:-4}},
             {text:"üëç Sobre",effects:{patience:+4}}],achievement:"lucky"},
  {emoji:"üïäÔ∏è",title:"Hasard bienveillant",desc:"Quelqu‚Äôun t‚Äôaide sans demander.",category:"rare",
    choices:[{text:"üòä Remercier",effects:{patience:+12}},
             {text:"üôè + Tip (2$)",cost:2,effects:{patience:+16}}],achievement:"lucky"},
  {emoji:"üí∏",title:"50$ trouv√©s",desc:"Par terre‚Ä¶",category:'rare',
   choices:[{text:"üí∞ Prendre",effects:{money:+50,patience:+12}},{text:"üöî Rapporter",effects:{patience:+8}}],achievement:'lucky'}
];

/* ================== PRICING (taxes & tips) ================== */
function priceWithNYC(cost, category){
  if(cost==null) return {total:0, breakdown:''};
  let base = cost;
  const diff = DIFFS[selectedDiff];
  base *= diff.price;

  let tax = base * TAX;
  let tip = 0;
  if(category==='food') tip = base * (TIP_MIN + Math.random()*(TIP_MAX-TIP_MIN));
  const total = base + tax + tip;

  return {
    total: Math.round(total*100)/100,
    breakdown: `‚âà ${base.toFixed(2)}$ + tax ${tax.toFixed(2)}${tip?` + tip ${tip.toFixed(2)}`:''}`
  };
}

/* ================== JOURNAL / ACHIEVEMENTS ================== */
function moodEmoji(){
  const s=game.state;
  const avg=(s.energy + s.patience + (100-s.hunger) + s.yamy)/4;
  if(avg<25) return 'üò≠'; if(avg<40) return 'üò´'; if(avg<60) return 'üòê'; if(avg<80) return 'üòä'; return 'üòÑ';
}
function addJournal(title,category){
  const s=game.state;
  let q="";
  if(s.yamy<40) q = pick(quotes.missYamy);
  else if(s.hunger>70) q = pick(quotes.hungry);
  else if(s.energy<30) q = pick(quotes.tired);
  else if(s.money<50) q = pick(quotes.broke);
  else if(s.patience<30) q = pick(quotes.impatient);
  else if(category==='yamy') q = pick(quotes.yamy);
  else if(category==='food') q = pick(quotes.food);
  else if(category==='photos') q = pick(quotes.photos);
  else q = Math.random()>0.5 ? pick(quotes.nyc) : pick(quotes.group);

  game.journal.unshift({
    day:s.day,action:s.actionCount,category:category||'general',
    quote:q,money:fmt(s.money),energy:fmt(s.energy),hunger:fmt(s.hunger),
    patience:fmt(s.patience),yamy:fmt(s.yamy),
    time:new Date().toLocaleTimeString('fr',{hour:'2-digit',minute:'2-digit'})
  });
  document.getElementById('journalBadge').textContent = game.journal.length;
  checkAchievements();
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function updateJournalUI(){
  const f = game.currentFilter;
  const list = f==='all'? game.journal : game.journal.filter(e=>e.category===f);
  const c = document.getElementById('journalEntries');
  if(!list.length){ c.innerHTML = `<div style="text-align:center;color:#888;padding:20px">Aucune entr√©e</div>`; }
  else {
    c.innerHTML = list.map(e=>`
      <div class="journal-entry">
        <div class="row" style="font-weight:700;color:#667eea"><div>Jour ${e.day} ¬∑ Act ${e.action}</div><div>${e.time}</div></div>
        <div style="margin:4px 0;opacity:.9"><span>${emojiForCat(e.category)} ${e.category}</span></div>
        <div style="font-style:italic;margin:6px 0">${e.quote}</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;font-size:.85em;opacity:.85">
          <div style="text-align:center">üí∞${e.money}</div>
          <div style="text-align:center">‚ö°${e.energy}%</div>
          <div style="text-align:center">üçî${e.hunger}%</div>
          <div style="text-align:center">üò§${e.patience}%</div>
          <div style="text-align:center">üíï${e.yamy}%</div>
        </div>
      </div>`).join('');
  }
  document.getElementById('journalStats').innerHTML = `
    <div style="text-align:center;background:rgba(102,126,234,.08);padding:8px;border-radius:10px">üóìÔ∏è Jour <b>${game.state.day}</b></div>
    <div style="text-align:center;background:rgba(102,126,234,.08);padding:8px;border-radius:10px">üìù <b>${game.journal.length}</b> entr√©es</div>
    <div style="text-align:center;background:rgba(102,126,234,.08);padding:8px;border-radius:10px">üí∞ $<b>${fmt(game.state.money)}</b></div>
    <div style="text-align:center;background:rgba(102,126,234,.08);padding:8px;border-radius:10px">üì∏ <b>${game.state.photos}</b></div>`;
}
function emojiForCat(cat){ const m={yamy:'üíï',food:'üçî',photos:'üì∏',mood:'üò§',transport:'üöá',spending:'üí≥',culture:'üé®',rare:'‚≠ê',energy:'‚ö°',weather:'‚òî',social:'üë•',fun:'üéÆ',money:'üí∞'}; return m[cat]||'üìù'; }

function updateAchievementsUI(){
  const c=document.getElementById('achievementsList');
  c.innerHTML = achievementsList.map(a=>{
    const unlocked=game.achievements.includes(a.id);
    return `<div style="display:flex;gap:12px;align-items:center;padding:10px;border-left:4px solid ${unlocked?'#667eea':'#999'};background:${unlocked?'rgba(102,126,234,.06)':'rgba(0,0,0,.04)'};border-radius:10px;margin-bottom:8px;opacity:${unlocked?1:.5}">
      <div style="font-size:2em">${a.icon}</div>
      <div><div style="font-weight:800;color:#667eea">${a.title}</div><div style="opacity:.85">${a.desc}</div></div>
    </div>`;
  }).join('');
  document.getElementById('achievementsBadge').textContent = game.achievements.length;
}

function checkAchievements(){
  achievementsList.forEach(a=>{
    if(!game.achievements.includes(a.id) && a.condition && a.condition()){
      game.achievements.push(a.id);
      showNote('üèÖ',`Achievement: ${a.title}`); sounds.achievement();
    }
  });
  updateAchievementsUI();
}

/* ================== EVENTS FLOW ================== */
function buildPool(){
  const pool = [];
  // base
  pool.push(...baseEvents);
  // conditional
  pool.push(...conditionals.filter(e=>!e.condition || e.condition()));
  // rares (faible proba)
  if(Math.random()<0.05){ // 5%
    const diff = DIFFS[selectedDiff];
    const r = pick(rares);
    if(diff.rareBuff>1 && r.choices[0].effects.patience) {
      // rendre moins "OP": on applique un petit malus sur positif si hard
      r.choices = r.choices.map(ch=>{
        const ef={...ch.effects};
        if(ef.patience) ef.patience = Math.round(ef.patience / diff.rareBuff);
        if(ef.money>0)  ef.money   = Math.round(ef.money   / diff.rareBuff);
        return {...ch, effects:ef};
      });
    }
    pool.push({...r, rare:true});
  }
  return pool;
}

function showEvent(){
  const list = buildPool();
  const e = pick(list);
  const rareClass = e.rare ? ' event-rare' : '';
  const catChip = `<div class="chip">${emojiForCat(e.category)} ${e.category}</div>`;
  const cont = document.getElementById('eventContainer');

  // Inject price previews with tax/tip
  const choicesHtml = e.choices.map((ch,i)=>{
    let effectsText = [];
    // dynamic pricing
    let priceLine = '';
    if('cost' in ch){
      const p = priceWithNYC(Math.abs(ch.cost), e.category);
      const total = ch.cost>=0 ? p.total : -p.total; // ATM ‚Äúgain‚Äù
      priceLine = ch.cost>=0 ? ` ¬∑ <span>co√ªt r√©el ‚âà ${total.toFixed(2)}$</span>` : ` ¬∑ <span>gain net ‚âà ${(-total).toFixed(2)}$</span>`;
      ch._priced = total; // cache
    }
    const ef = ch.effects||{};
    if(ef.energy) effectsText.push(`‚ö°${ef.energy>0?'+':''}${ef.energy}%`);
    if(ef.hunger) effectsText.push(`üçî${ef.hunger>0?'+':''}${ef.hunger}%`);
    if(ef.patience) effectsText.push(`üò§${ef.patience>0?'+':''}${ef.patience}%`);
    if(ef.yamy) effectsText.push(`üíï${ef.yamy>0?'+':''}${ef.yamy}%`);
    if(ef.photos) effectsText.push(`üì∏+${ef.photos}`);

    return `<button class="choice-btn" data-idx="${i}">
      <div class="choice-line"><div>${ch.text}</div><div class="mini">${priceLine}</div></div>
      <div class="effects">${effectsText.join(' ¬∑ ') || '‚Äî'}</div>
    </button>`;
  }).join('');

  cont.innerHTML = `
    <div class="event-card${rareClass}">
      <div class="event-emoji">${e.emoji}</div>
      <div class="event-title">${e.title}</div>
      ${catChip}
      <div class="event-description">${e.desc}</div>
      <div class="choices" id="choices">${choicesHtml}</div>
    </div>`;

  const btns = [...document.querySelectorAll('.choice-btn')];
  btns.forEach(b=>b.addEventListener('click', ()=>{
    btns.forEach(x=>x.disabled=true); // anti double clic
    sounds.click();
    const idx = +b.dataset.idx;
    resolveChoice(e, e.choices[idx]);
  }));

  // Keyboard shortcuts
  window.onkeydown = (ev)=>{
    if(ev.key==='1' && btns[0]) btns[0].click();
    if(ev.key==='2' && btns[1]) btns[1].click();
    if(ev.key.toLowerCase()==='j') toggleOverlay('journalOverlay', true);
    if(ev.key.toLowerCase()==='a') toggleOverlay('achievementsOverlay', true);
    if(ev.key.toLowerCase()==='s') toggleOverlay('statsOverlay', true);
  };
}

function resolveChoice(evt, ch){
  const s=game.state;
  // Combo
  if(s.lastChoiceType===evt.category){
    s.combo++;
    document.getElementById('comboIndicator').classList.remove('hidden');
    document.getElementById('comboX').textContent = `x${s.combo}`;
    if(s.combo===5 && !game.achievements.includes('combo_master')){
      game.achievements.push('combo_master'); showNote('üî•','Achievement: Combo Master'); sounds.achievement();
    }
  } else {
    s.combo=1; document.getElementById('comboIndicator').classList.add('hidden');
  }
  s.lastChoiceType=evt.category;
  const comboBonus = s.combo>=2 ? 1 + (s.combo*0.05) : 1;
  const apply = v => v ? Math.round(v * (v>0? comboBonus:1)) : 0;

  // MONEY (with taxes)
  if('_priced' in ch){
    const delta = ch._priced; // already signed
    s.money -= delta; // cost positive decreases money; ATM negative increases
    // spending buckets
    if(delta>0){
      const amount = delta;
      if(evt.category==='food') game.spending.food+=amount;
      else if(evt.category==='transport') game.spending.transport+=amount;
      else if(evt.category==='culture') game.spending.culture+=amount;
      else if(evt.category==='spending') game.spending.shopping+=amount;
      else game.spending.other+=amount;
      game.daySpending += amount;
      if(game.daySpending>=300 && !game.achievements.includes('spender')){
        game.achievements.push('spender'); showNote('üí≥','Achievement: D√©pensi√®re'); sounds.achievement();
      }
    }
  }

  // APPLY EFFECTS
  const ef=ch.effects||{};
  s.energy   += apply(ef.energy||0);
  s.hunger   += apply(ef.hunger||0);
  s.patience += apply(ef.patience||0);
  s.yamy     += apply((ef.yamy||0) - DIFFS[selectedDiff].yamyWear); // usure relationnelle
  s.photos   += (ef.photos||0);

  // Fatigue passive par jour
  s.energy -= DIFFS[selectedDiff].energyDaily;

  // Faim naturelle
  if(s.actionCount%2===0) s.hunger += DIFFS[selectedDiff].hungerTick;

  // Bornes
  s.money = Math.max(0, s.money);
  s.energy = clamp(s.energy,0,100);
  s.hunger = clamp(s.hunger,0,100);
  s.patience = clamp(s.patience,0,100);
  s.yamy = clamp(s.yamy,0,100);

  // Trackers
  if((evt.title.includes('Marche')||evt.title.includes('pied')) && ch.text.includes('Marcher')){
    game.walkCount++; if(game.walkCount>=5 && !game.achievements.includes('walker')){ game.achievements.push('walker'); showNote('üö∂‚Äç‚ôÄÔ∏è','Achievement: Marcheuse'); sounds.achievement(); }
  }
  if((evt.title.includes('M√©tro')||evt.category==='transport') && ch.text.includes('M√©tro')){
    game.metroCount++; if(game.metroCount>=10 && !game.achievements.includes('metro_master')){ game.achievements.push('metro_master'); showNote('üöá','Achievement: Metro Master'); sounds.achievement(); }
  }

  // Achievement direct attach√© au choix
  if(ch.achievement && !game.achievements.includes(ch.achievement)){
    game.achievements.push(ch.achievement);
    const a = achievementsList.find(x=>x.id===ch.achievement);
    if(a){ showNote(a.icon,`Achievement: ${a.title}`); sounds.achievement(); }
  }

  s.actionCount++;
  s.statsHistory.push({ action:s.actionCount, money:s.money, energy:s.energy, hunger:s.hunger, patience:s.patience, yamy:s.yamy });

  addJournal(evt.title, evt.category);
  renderState();

  if(checkGameOver()) return;

  // Changement de jour
  if(s.actionCount % DAY_ACTIONS === 0){
    s.day++;
    if(s.day>5){ victory(); return; }
    showNote('üóìÔ∏è',`Jour ${s.day} ‚Äî difficult√© cumul√©e`);
    game.daySpending=0; game.patienceStreak=0;
  }
  setTimeout(showEvent, 500);
}

/* ================== RENDER ================== */
function renderState(){
  const s=game.state;
  const turnsLeft = DAY_ACTIONS - (s.actionCount % DAY_ACTIONS || DAY_ACTIONS);
  document.getElementById('turnsLeft').textContent = turnsLeft;

  document.getElementById('day').textContent = s.day;
  document.getElementById('money').textContent = fmt(s.money);
  document.getElementById('energy').textContent = fmt(s.energy);
  document.getElementById('hunger').textContent = fmt(s.hunger);
  document.getElementById('patience').textContent = fmt(s.patience);
  document.getElementById('yamy').textContent = fmt(s.yamy);
  document.getElementById('moodIcon').textContent = moodEmoji();

  document.getElementById('moneyBar').style.width = (s.maxMoney? Math.min(100,(s.money/s.maxMoney)*100) : 100)+'%';
  document.getElementById('energyBar').style.width = s.energy+'%';
  document.getElementById('hungerBar').style.width = s.hunger+'%';
  document.getElementById('patienceBar').style.width = s.patience+'%';
  document.getElementById('yamyBar').style.width = s.yamy+'%';

  // Critiques
  const crits=[];
  if(s.money<50) crits.push('üí∏ Budget critique');
  if(s.energy<30) crits.push('üò¥ √ânergie basse');
  if(s.hunger>70) crits.push('üçî Faim √©lev√©e');
  if(s.patience<30) crits.push('üò° Patience faible');
  if(s.yamy<30) crits.push('üíî Manque de Yamy');
  document.getElementById('critBox').innerHTML = crits.length ? `<div class="row" style="color:#ffd700">${crits.join(' ¬∑ ')}</div>` : '';

  toggleCrit('moneyLabel', s.money>=50);
  toggleCrit('energyLabel', s.energy>=30);
  toggleCrit('hungerLabel', s.hunger<=70);
  toggleCrit('patienceLabel', s.patience>=30);
  toggleCrit('yamyLabel', s.yamy>=30);
}
function toggleCrit(id, ok){
  const el=document.getElementById(id);
  if(!el) return;
  el.classList.toggle('crit', !ok);
}

/* ================== OVERLAYS & NAV ================== */
function toggleOverlay(id, forceShow){
  const ov = document.getElementById(id);
  const show = forceShow ?? !ov.classList.contains('show');
  if(show){
    ov.classList.add('show');
    if(id==='journalOverlay') updateJournalUI();
    if(id==='achievementsOverlay') updateAchievementsUI();
    if(id==='statsOverlay') updateStatsOverlay();
    // click outside to close
    ov.onclick = (e)=>{ if(e.target===ov) ov.classList.remove('show'); };
  } else ov.classList.remove('show');
}
function updateStatsOverlay(){
  const h = game.state.statsHistory.slice(-24);
  document.getElementById('statsHistory').innerHTML = `
    <div style="background:rgba(102,126,234,.08);padding:10px;border-radius:10px">
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;font-weight:800;text-align:center">
        <div>üí∞</div><div>‚ö°</div><div>üçî</div><div>üò§</div><div>üíï</div>
      </div>
      ${h.map(x=>`
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;text-align:center;border-top:1px solid rgba(0,0,0,.08);padding:4px 0">
          <div>${fmt(x.money)}</div><div>${fmt(x.energy)}</div><div>${fmt(x.hunger)}</div><div>${fmt(x.patience)}</div><div>${fmt(x.yamy)}</div>
        </div>`).join('')}
    </div>`;
  const total = Object.values(game.spending).reduce((a,b)=>a+b,0);
  const cat = {food:'üçî Nourriture',transport:'üöá Transport',culture:'üé® Culture',shopping:'üõçÔ∏è Shopping',other:'üì¶ Autre'};
  document.getElementById('spendingBreakdown').innerHTML = `
    <div style="background:rgba(102,126,234,.08);padding:10px;border-radius:10px">
    ${Object.entries(game.spending).map(([k,v])=>{
      const p = total? Math.round(v/total*100):0;
      return `<div style="margin:6px 0">
        <div class="row"><span>${cat[k]}</span><span><b>${fmt(v)}</b> (${p}%)</span></div>
        <div style="height:10px;background:rgba(0,0,0,.15);border-radius:8px;overflow:hidden"><div style="height:100%;width:${p}%;background:#667eea"></div></div>
      </div>`;
    }).join('')}
    <div style="text-align:center;margin-top:8px;font-weight:800">Total: ${fmt(total)}$</div>
    </div>`;
  document.getElementById('generalStats').innerHTML = `
    <div style="background:rgba(102,126,234,.08);padding:12px;border-radius:10px;text-align:center"><div style="font-size:1.3em;font-weight:800;color:#667eea">${game.state.actionCount}</div><div>Actions</div></div>
    <div style="background:rgba(102,126,234,.08);padding:12px;border-radius:10px;text-align:center"><div style="font-size:1.3em;font-weight:800;color:#667eea">${game.state.photos}</div><div>Photos</div></div>
    <div style="background:rgba(102,126,234,.08);padding:12px;border-radius:10px;text-align:center"><div style="font-size:1.3em;font-weight:800;color:#667eea">${game.journal.length}</div><div>Journal</div></div>
    <div style="background:rgba(102,126,234,.08);padding:12px;border-radius:10px;text-align:center"><div style="font-size:1.3em;font-weight:800;color:#667eea">${game.achievements.length}/25</div><div>Achievements</div></div>`;
}

/* ================== GAME LIFECYCLE ================== */
function startGame(){
  sounds.click();
  // init difficulty
  document.getElementById('diffLabel').textContent = DIFFS[selectedDiff].label;

  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  document.getElementById('bottomNav').classList.remove('hidden');

  Object.assign(game.state, { day:1, actionCount:0, money:300, energy:100, hunger:40, patience:100, yamy:100, photos:0, maxMoney:300, combo:0, lastChoiceType:null, statsHistory:[] });
  game.journal=[]; game.achievements=[]; game.usedEvents=[]; game.currentFilter='all';
  game.spending={ food:0, transport:0, culture:0, shopping:0, other:0 };
  game.energyStreak=0; game.patienceStreak=0; game.daySpending=0; game.miniGamesWon=0; game.walkCount=0; game.metroCount=0; game.kevinAvoidCount=0;

  renderState(); updateAchievementsUI(); showEvent();
  showNote('üóΩ','Bienvenue √† NYC‚Ä¶ bonne chance !');
}

function restartGame(){
  document.getElementById('gameOverScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  document.getElementById('bottomNav').classList.remove('hidden');
  ['journalOverlay','achievementsOverlay','statsOverlay'].forEach(id=>document.getElementById(id).classList.remove('show'));
  startGame();
}

function checkGameOver(){
  const s=game.state;
  let r='';
  if(s.money<=0) r="üí∏ Fauch√©e ‚Äî impossible de continuer.";
  else if(s.energy<=0) r="üò¥ Effondr√©e de fatigue.";
  else if(s.hunger>=100) r="üçî Malaise de faim.";
  else if(s.patience<=0) r="üò° A explos√©‚Ä¶ (social KO).";
  else if(s.yamy<=0) r="üíî Le manque de Yamy est trop fort.";
  if(r){ endGame(r); return true; }
  return false;
}
function endGame(reason){
  document.getElementById('gameScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.remove('hidden');
  document.getElementById('bottomNav').classList.add('hidden');
  document.getElementById('gameOverReason').textContent = reason;

  document.getElementById('finalDays').textContent=game.state.day;
  document.getElementById('finalActions').textContent=game.state.actionCount;
  document.getElementById('finalMoney').textContent=fmt(game.state.money);
  document.getElementById('finalPhotos').textContent=game.state.photos;
  document.getElementById('finalAchievements').textContent=game.achievements.length;

  checkAchievements();
}
function victory(){
  checkAchievements();
  endGame(`üéâ VICTOIRE ! 5 jours √† NYC ‚Äî ${game.state.photos} photos et des souvenirs‚Ä¶`);
}

/* ================== WIRING ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // difficulty select
  document.querySelectorAll('#diffSelect .pill').forEach(btn=>{
    if(btn.dataset.diff===selectedDiff) btn.classList.add('active');
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#diffSelect .pill').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      selectedDiff = btn.dataset.diff;
      localStorage.setItem('msnyc_diff', selectedDiff);
    });
  });

  document.getElementById('startBtn').addEventListener('click', startGame);
  document.getElementById('restartBtn').addEventListener('click', restartGame);

  // bottom nav
  document.getElementById('journalBtn').addEventListener('click', ()=>toggleOverlay('journalOverlay'));
  document.getElementById('achievementsBtn').addEventListener('click', ()=>toggleOverlay('achievementsOverlay'));
  document.getElementById('statsBtn').addEventListener('click', ()=>toggleOverlay('statsOverlay'));
  document.getElementById('soundBtn').addEventListener('click', ()=>{
    soundEnabled = !soundEnabled;
    localStorage.setItem('msnyc_sound', JSON.stringify(soundEnabled));
    document.getElementById('soundBtn').textContent = soundEnabled? 'üîä':'üîá';
    if(soundEnabled) sounds.success();
  });
  document.getElementById('soundBtn').textContent = soundEnabled? 'üîä':'üîá';

  // overlay close buttons
  document.querySelectorAll('.overlay [data-close]').forEach(b=>b.addEventListener('click', (e)=> e.currentTarget.closest('.overlay').classList.remove('show')));

  // filters
  document.getElementById('filters').addEventListener('click', (e)=>{
    const btn = e.target.closest('.filter-btn'); if(!btn) return;
    document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active'); game.currentFilter = btn.dataset.filter; updateJournalUI();
  });
});
</script>
</body>
</html>
